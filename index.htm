<script>
const $=id=>document.getElementById(id),S=localStorage,bmKey=()=>`bookmarks_${currentBookUrl}`;let currentBookUrl="",book, rendition, bookmarks=[],xDown=null,yDown=null,swipeInProgress=false,currentFontSize=+S.getItem("reader-font-size")||100,currentFlow=S.getItem("reading-mode")||"swipe",lastNonNightTheme="light",openMenuType=null;const swipe=d=>{if(swipeInProgress)return;swipeInProgress=!0;const v=$("viewer");v.classList.add("swipe-transition"),v.style.transform=`translateX(${d==="next"?"-100%":"100%"})`,setTimeout(()=>{d==="next"?rendition.next():rendition.prev(),v.classList.remove("swipe-transition"),v.style.transform="",swipeInProgress=!1},300)},getCfi=()=>rendition?.currentLocation()?.start?.cfi,updateStar=()=>{const b=$("bookmark-toggle"),cfi=getCfi();if(!cfi)return b.textContent="☆";const e=bookmarks.some(bm=>bm.cfi===cfi);b.textContent=e?"★":"☆",b.style.color=e?"blue":""},updateBMUI=()=>{const c=$("bookmark-panel");c.innerHTML="";if(!bookmarks.length)return c.textContent="No bookmarks yet.";bookmarks.forEach(b=>{const d=document.createElement("div");d.textContent=`Page ${b.page||"?"} - ${b.snippet}`,d.onclick=()=>{rendition.display(b.cfi),$("bookmark-panel").classList.remove("open")},c.appendChild(d)})},toggleBM=()=>{const cfi=getCfi(),i=bookmarks.findIndex(b=>b.cfi===cfi);if(i!==-1)bookmarks.splice(i,1);else{let s="";rendition.getContents().forEach(cnt=>s||=cnt.document.body.textContent?.trim().slice(0,100));bookmarks.push({cfi,snippet:s+"...",page:rendition.location?.start?.index||"?"})}S.setItem(bmKey(),JSON.stringify(bookmarks)),updateStar(),updateBMUI()},loadBookmarks=()=>{bookmarks=JSON.parse(S.getItem(bmKey())||"[]"),updateBMUI(),updateStar()},changeTheme=t=>{document.body.className=`${t}-mode`,$("theme-toggle").textContent=t==="night"?"☀️":"🌙",$("theme-select").value=t,S.setItem("reader-theme",t),rendition?.getContents().forEach(c=>{let d=c.document,bg="#fff",fg="#000";if(t==="night")bg="#111",fg="#eee";else if(t==="sepia")bg="#f4ecd8";else if(t==="matcha")bg="#C3D8B6";d.documentElement.style.background=bg,d.body.style.background=bg,d.body.style.color=fg})},applyFont=()=>{const f=S.getItem("reader-font")||"-apple-system";$("font-switcher").value=f;if(!rendition)return;if(f==="OpenDyslexic"){const st=`@font-face{font-family:"OpenDyslexic";src:url("/fonts/OpenDyslexic-Regular.otf") format("opentype");}@font-face{font-family:"OpenDyslexic";src:url("/fonts/OpenDyslexic-Bold.otf") format("opentype");font-weight:bold;}body{font-family:"OpenDyslexic",sans-serif!important;}`;rendition.getContents().forEach(c=>{let d=c.document;if(!d.getElementById("OpenDyslexicStyle")){const e=document.createElement("style");e.id="OpenDyslexicStyle",e.innerHTML=st,d.head.appendChild(e)}})}else{rendition.themes.override("body",{"font-family":`${f},serif!important`}),rendition.getContents().forEach(c=>{let d=c.document,e=d.getElementById("fontOverrideStyle")||d.createElement("style");e.id="fontOverrideStyle",e.textContent=`body{font-family:${f},serif!important;}`,d.head.appendChild(e)})}},initBook=url=>{if(!url)return;currentBookUrl=url,bookmarks=[],rendition&&rendition.destroy(),book&&book.destroy(),book=ePub(url),book.ready.then(()=>{rendition=book.renderTo("viewer",{width:"100%",height:"100%",flow:currentFlow==="scrolled-doc"?"scrolled":"paginated",snap:currentFlow!=="scrolled-doc",spread:"always",direction:"ltr"}),rendition.display(S.getItem("last-location-"+url)||undefined),rendition.on("relocated",l=>{l?.start?.cfi&&S.setItem("last-location-"+url,l.start.cfi),updateStar()}),rendition.on("rendered",()=>{applyFont(),updateStar()}),applyFont(),loadBookmarks(),book.loaded.metadata.then(m=>{m.title&&($("book-title").textContent=m.title),m.creator&&($("book-author").textContent=m.creator)}),book.loaded.cover.then(c=>book.archive.createUrl(c,{base64:!0})).then(u=>{$("cover").src=u}).catch(()=>{}),book.loaded.navigation.then(nav=>{const toc=$("toc-panel");toc.innerHTML="",nav.toc.forEach(ch=>{if(!/contents/i.test(ch.label)){const a=document.createElement("a");a.textContent=ch.label,a.href="#",a.onclick=e=>{e.preventDefault(),rendition.display(ch.href),toc.classList.remove("open")},toc.appendChild(a)}})})})};["tap-left","tap-right"].forEach(id=>$(`${id}`).addEvent_

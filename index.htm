<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" />
<title>My ePub Reader and Library</title>
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:sans-serif;background:#f5f5f5}
#reader-container,#library-container{position:relative;width:100%;height:100%;display:none}
#toolbar{position:fixed;top:0;left:0;right:0;height:40px;z-index:1002;display:flex;justify-content:space-evenly;align-items:center;padding:0 10px;background:#eee}
#toolbar button{width:40px;height:40px;background:transparent;border:none;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.8}
#toolbar button:hover{opacity:1}
#expanded-menu{position:fixed;top:0;bottom:0;left:-100%;width:80%;max-width:300px;background:#444;color:#fff;z-index:1010;display:flex;flex-direction:column;padding:20px;overflow-y:auto;transition:left .3s ease}
#expanded-menu.open{left:0}
#menu-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:1001}
#book-card img{width:100%;border-radius:4px;margin-bottom:10px}
#viewer{position:absolute;top:40px;left:0;right:0;bottom:30px;touch-action:pan-x;overflow:hidden}
#tap-left,#tap-right{position:absolute;top:0;bottom:0;width:33.333%;z-index:998}
#tap-left{left:0}#tap-right{right:0}
#gesture-left,#gesture-right{position:absolute;top:0;bottom:0;width:40%;z-index:999;pointer-events:none}
#gesture-left{left:0}#gesture-right{right:0}
#toc-panel,#bookmark-panel{position:fixed;top:40px;left:0;right:0;height:60vh;overflow:auto;background:#222;color:#fff;z-index:1000;display:none}
#toc-panel.open,#bookmark-panel.open{display:block}
#toc-panel a,#bookmark-panel div{padding:8px 10px;display:block;color:#fff;text-decoration:none}
#toc-panel a:hover,#bookmark-panel div:hover{background:#333}
</style></head><body>
<div id="library-container"><h1>ðŸ“š My Book Library</h1>
<div id="library-controls"><button onclick="toggleLibrary(false)">Back to Reader</button></div>
<div id="library">Loading books...</div></div>

<div id="reader-container">
  <div id="toolbar">
    <button id="menu-toggle" title="Main Menu">â˜°</button>
    <button id="toc-toggle" title="Table of Contents">ðŸ“–</button>
    <button id="bookmark-toggle" title="Toggle Bookmark">â˜†</button>
    <button id="bookmark-dropdown" title="Bookmarks">ðŸ”–</button>
    <button id="settings-toggle" title="Read Settings">Aa</button>
  </div>
  <div id="viewer"><div id="tap-left"></div><div id="tap-right"></div><div id="gesture-left"></div><div id="gesture-right"></div></div>
  <div id="bookmark-panel"></div>
  <div id="menu-backdrop"></div>
  <div id="expanded-menu">
    <button class="close-menu" onclick="toggleMenu('menu')">Ã—</button>
    <div id="book-card"><img id="cover" alt="Book Cover" /><div id="book-title"></div><div id="book-author"></div></div>
    <button onclick="toggleLibrary(true)">Library</button>
  </div>
  <div id="toc-panel"></div>
</div>

<script>
const $=id=>document.getElementById(id),S=localStorage;
let book,rendition,bookmarks=[],currentBookUrl="",flow=S.getItem("reading-mode")||"paginated",font=+S.getItem("reader-font-size")||100;
const key=()=>`bookmarks_${currentBookUrl}`,getCfi=()=>rendition?.currentLocation()?.start?.cfi;

const loadBookmarks=()=>{bookmarks=JSON.parse(S.getItem(key())||"[]");drawBookmarks();updateStar()};
const updateStar=()=>{$("bookmark-toggle").textContent=bookmarks.some(b=>b.cfi===getCfi())?"â˜…":"â˜†"};
const drawBookmarks=()=>{const p=$("bookmark-panel");p.innerHTML="";bookmarks.forEach(b=>{const d=document.createElement("div");d.textContent=b.snippet||b.cfi;d.onclick=()=>rendition.display(b.cfi);p.appendChild(d)})};
const toggleBookmark=()=>{const cfi=getCfi(),i=bookmarks.findIndex(b=>b.cfi===cfi);i>-1?bookmarks.splice(i,1):bookmarks.push({cfi,snippet:"Bookmark"});S.setItem(key(),JSON.stringify(bookmarks));drawBookmarks();updateStar()};
const toggleLibrary=show=>{const a=$("library-container"),b=$("reader-container");[a,b].forEach(e=>e.style.display="none");(show?a:b).style.display="block";closeMenus()};
const initBook=url=>{currentBookUrl=url;book=ePub(url);rendition=book.renderTo("viewer",{width:"100%",height:"100%",flow:flow==="scrolled-doc"?"scrolled":"paginated"});rendition.display(S.getItem("last-location-"+url)||undefined);rendition.on("relocated",l=>{S.setItem("last-location-"+url,l.start.cfi);updateStar()});
book.loaded.navigation.then(nav=>{const t=$("toc-panel");t.innerHTML="";nav.toc.forEach(ch=>{const a=document.createElement("a");a.textContent=ch.label;a.href="#";a.onclick=e=>{e.preventDefault();rendition.display(ch.href)};t.appendChild(a)})});
book.loaded.metadata.then(meta=>{$("book-title").textContent=meta.title||"Untitled";$("book-author").textContent=meta.creator||""});
book.loaded.cover.then(u=>book.archive.createUrl(u,{base64:!0})).then(u=>{$("cover").src=u}).catch(()=>0);loadBookmarks()};
const readBook=url=>{S.setItem("last-book",url);initBook(url);toggleLibrary(false)};
const loadLibrary=()=>{fetch("/ebooks/library.json").then(r=>r.json()).then(b=>{const l=$("library");l.innerHTML="";b.forEach(book=>{const d=document.createElement("div");d.textContent=book.title;d.onclick=()=>readBook(book.fileUrl);d.style.cursor="pointer";l.appendChild(d)})})};

$("menu-toggle").onclick=()=>{$("expanded-menu").classList.toggle("open");$("menu-backdrop").style.display="block"};
$("menu-backdrop").onclick=closeMenus;
$("bookmark-toggle").onclick=toggleBookmark;
$("bookmark-dropdown").onclick=()=>$("bookmark-panel").classList.toggle("open");
$("toc-toggle").onclick=()=>$("toc-panel").classList.toggle("open");
$("tap-left").onclick=()=>rendition.prev();$("tap-right").onclick=()=>rendition.next();

function closeMenus(){$("expanded-menu").classList.remove("open");$("menu-backdrop").style.display="none"}
(()=>{const url=new URLSearchParams(location.search).get("book")||S.getItem("last-book");url?readBook(url):toggleLibrary(true);loadLibrary()})();
</script>
</body></html>

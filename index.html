<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BTS Reader ‚Äì Notes + iOS Highlights</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      overflow: hidden;
    }

    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 45px;
      background: #222;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      z-index: 100;
    }

    #toolbar button {
      margin-right: 1rem;
      padding: 6px 12px;
      font-size: 1rem;
      background: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #note-list {
      position: fixed;
      top: 45px;
      right: 0;
      left: 0;
      max-height: 60vh;
      overflow-y: auto;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px;
      display: none;
      z-index: 200;
    }

    .note-item {
      border-bottom: 1px solid #444;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .note-snippet {
      flex-grow: 1;
      margin-right: 10px;
      font-size: 14px;
    }

    .note-delete {
      cursor: pointer;
      color: red;
      font-size: 16px;
    }

    #note-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 8px;
      padding: 16px;
      z-index: 999;
      display: none;
      width: 90%;
      max-width: 300px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }

    #note-modal textarea {
      width: 100%;
      height: 80px;
      resize: none;
      margin-bottom: 10px;
      font-size: 14px;
    }

    #note-modal button {
      margin-right: 10px;
    }

    #reader-container {
      position: absolute;
      top: 45px;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
    }

    #viewer {
      width: 100%;
      height: 100%;
    }

    #tap-left, #tap-right {
      position: absolute;
      top: 45px;
      bottom: 0;
      width: 35%;
      z-index: 10;
    }

    #tap-left { left: 0; }
    #tap-right { right: 0; }
  </style>
</head>
<body>

  <div id="toolbar">
    <button id="highlightToggle">üìù Highlight</button>
    <button id="notesToggle">üìí Notes</button>
  </div>

  <div id="note-list"></div>

  <div id="note-modal">
    <textarea id="noteInput" placeholder="Optional note..."></textarea><br>
    <button onclick="saveNote()">Save</button>
    <button onclick="closeNoteModal()">Cancel</button>
  </div>

  <div id="reader-container">
    <div id="viewer"></div>
    <div id="tap-left"></div>
    <div id="tap-right"></div>
  </div>

  <script>
    let highlightMode = false;
    let highlights = [];
    let pendingCFI = null;
    const key = "highlights-bts";

    const tapLeft = document.getElementById("tap-left");
    const tapRight = document.getElementById("tap-right");
    const toggleBtn = document.getElementById("highlightToggle");
    const notesToggle = document.getElementById("notesToggle");
    const noteList = document.getElementById("note-list");

    toggleBtn.onclick = () => {
      highlightMode = !highlightMode;
      toggleBtn.style.background = highlightMode ? "orange" : "#444";
      tapLeft.style.pointerEvents = highlightMode ? "none" : "auto";
      tapRight.style.pointerEvents = highlightMode ? "none" : "auto";
    };

    notesToggle.onclick = () => {
      noteList.style.display = noteList.style.display === "block" ? "none" : "block";
      renderNoteList();
    };

    const book = ePub("/ebooks/bts.epub");
    const rendition = book.renderTo("viewer", {
      width: "100%",
      height: "100%",
      flow: "scrolled-doc",
      allowScriptedContent: true,
      manager: "default"
    });

    function saveHighlights() {
      localStorage.setItem(key, JSON.stringify(highlights));
    }

    function loadHighlights() {
      const saved = localStorage.getItem(key);
      if (saved) {
        highlights = JSON.parse(saved);
        highlights.forEach(h =>
          rendition.annotations.highlight(h.cfi, {}, null, "hl")
        );
      }
    }

    function renderNoteList() {
      noteList.innerHTML = "";
      highlights.forEach((h, index) => {
        const div = document.createElement("div");
        div.className = "note-item";

        const snippet = document.createElement("div");
        snippet.className = "note-snippet";
        snippet.textContent = (h.text || "").slice(0, 100);

        const delBtn = document.createElement("div");
        delBtn.className = "note-delete";
        delBtn.textContent = "üóë";
        delBtn.onclick = () => {
          rendition.annotations.remove(h.cfi, "highlight");
          highlights.splice(index, 1);
          saveHighlights();
          renderNoteList();
        };

        div.appendChild(snippet);
        div.appendChild(delBtn);
        noteList.appendChild(div);
      });
    }

    function showNoteModal(cfi, text) {
      pendingCFI = cfi;
      document.getElementById("noteInput").value = "";
      document.getElementById("note-modal").style.display = "block";
    }

    function closeNoteModal() {
      document.getElementById("note-modal").style.display = "none";
      pendingCFI = null;
    }

    function saveNote() {
      const noteText = document.getElementById("noteInput").value.trim();
      if (pendingCFI) {
        const range = highlights.find(h => h.cfi === pendingCFI);
        if (range) {
          range.note = noteText;
        }
        saveHighlights();
        closeNoteModal();
      }
    }

    rendition.on("rendered", () => {
      loadHighlights();
    });

    rendition.hooks.content.register(contents => {
      const doc = contents.document;
      doc.body.style.userSelect = "text";
      doc.documentElement.style.userSelect = "text";
      doc.body.style.webkitUserSelect = "text";
      doc.documentElement.style.webkitUserSelect = "text";
      doc.body.style.webkitTouchCallout = "none";

      const style = doc.createElement("style");
      style.innerHTML = `
        .epubjs-hl {
          background: rgba(255, 255, 0, 0.4) !important;
          box-shadow: none !important;
          mix-blend-mode: multiply;
          pointer-events: none;
        }
      `;
      doc.head.appendChild(style);
    });

    rendition.on("selected", async (cfiRange, contents) => {
      if (!highlightMode) return;

      const existing = highlights.find(h => h.cfi === cfiRange);
      if (existing) {
        rendition.annotations.remove(cfiRange, "highlight");
        highlights = highlights.filter(h => h.cfi !== cfiRange);
        saveHighlights();
        renderNoteList();
      } else {
        const range = await book.getRange(cfiRange);
        const text = range.toString().trim();
        if (text.length > 0) {
          rendition.annotations.highlight(cfiRange, {}, null, "hl");
          highlights.push({ cfi: cfiRange, text, note: "" });
          showNoteModal(cfiRange, text);
        }
      }

      contents.window.getSelection().removeAllRanges();
    });

    tapLeft.onclick = () => { if (!highlightMode) rendition.prev(); };
    tapRight.onclick = () => { if (!highlightMode) rendition.next(); };

    rendition.display();
  </script>
</body>
</html>

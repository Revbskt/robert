<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My ePub Reader and Library</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />

  <!-- JSZip and epub.js for the reader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    /* ===== Global UI Font Setup ===== */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    /* ===== Theme Classes for the Body ===== */
    body.light-mode { background: #f5f5f5; }
    body.light-mode #toolbar { background: #eee; }
    body.sepia-mode { background: #f4ecd8; }
    body.sepia-mode #toolbar { background: #e7dbc3; }
    body.matcha-mode { background: #C3D8B6; }
    body.matcha-mode #toolbar { background: #B0CFA3; }
    body.night-mode { background: #111 !important; }
    body.night-mode #toolbar { background: #222 !important; }
    body.night-mode #continue-bar { background: #111 !important; color: #eee !important; }
        /* ===== Layout for Library and Reader Containers ===== */
    #reader-container {
      display: none;
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #library-container {
      display: none;
      position: relative;
      min-height: 100vh;
      background: #f5f5f5;
      padding: 1rem;
      box-sizing: border-box;
    }
    h1 { text-align: center; margin: 0 0 1rem; }

    /* ===== Library Grid Styling ===== */
    #library-controls { text-align: center; margin-bottom: 1rem; }
    #library {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 1rem;
    }
    .book {
      background: #fff;
      border: 1px solid #ddd;
      padding: 0.75rem;
      width: 140px;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
    }
    .book img { width: 100%; height: auto; border-radius: 4px; }
    .book h3 { font-size: 0.9rem; margin: 0.5rem 0 0.25rem; }
    .book p { font-size: 0.8rem; margin: 0 0 0.5rem; color: #555; }
    .book button {
      margin: 4px 0;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .book button:hover { background-color: #0056b3; }

    /* ===== Reader Toolbar (UI) ===== */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      z-index: 1002;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      padding: 0 10px;
    }
    #toolbar button {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.8;
      pointer-events: auto;
    }
    #toolbar button:hover { opacity: 1; }

    /* ===== Bookmark Panel (dropdown like the TOC) ===== */
    #bookmark-panel {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      height: 70vh;
      overflow-y: auto;
      background: rgba(0,0,0,0.85);
      border-bottom: 1px solid #444;
      z-index: 1000;
      transition: transform 0.3s ease;
      transform: translateY(-100%);
    }
    #bookmark-panel.open { transform: translateY(0); }
    #bookmark-panel div {
      display: block;
      padding: 6px 10px;
      text-decoration: none;
      color: #fff;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #bookmark-panel div:hover { background: rgba(255,255,255,0.1); }

    /* ===== Compass Panel (NEW) ===== */
    #compass-panel {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      height: 70vh;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.85);
      border-bottom: 1px solid #444;
      z-index: 1000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      padding: 10px;
      color: white;
    }
    #compass-panel.open { transform: translateY(0); }
    #compass-panel h4 { margin: 0 0 10px; text-align: center; }
    #compass-panel .location-info { font-size: 14px; margin-bottom: 10px; text-align: center; }
    #compass-panel input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    #compass-panel input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #555;
      margin-bottom: 10px;
    }
    #compass-panel .search-results {
      max-height: 150px;
      overflow-y: auto;
      border-top: 1px solid #555;
      padding-top: 8px;
    }
    #compass-panel .search-results div {
      padding: 5px 10px;
      cursor: pointer;
      border-bottom: 1px solid #333;
    }
    #compass-panel .search-results div:hover {
      background: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body class="light-mode">
  <!-- LIBRARY CONTAINER -->
  <div id="library-container">
    <h1>üìö My Book Library</h1>
    <div id="library-controls">
      <button onclick="toggleLibrary(false)">Back to Reader</button>
    </div>
    <div id="library">Loading books...</div>
  </div>

  <!-- READER CONTAINER -->
  <div id="reader-container">
    <div id="toolbar">
      <button id="menu-toggle" title="Main Menu">‚ò∞</button>
      <button id="toc-toggle" title="Table of Contents">üìñ</button>
      <button id="bookmark-toggle" title="Toggle Bookmark">‚òÜ</button>
      <button id="bookmark-dropdown" title="Bookmarks">üîñ</button>
      <button id="compass-toggle" title="Page Navigator">üß≠</button>
      <button id="settings-toggle" title="Read Settings">Aa</button>
      <button id="theme-toggle" title="Toggle Night Mode">üåô</button>
    </div>

    <!-- Bookmark Dropdown Panel -->
    <div id="bookmark-panel"></div>

    <!-- Compass Dropdown Panel (NEW) -->
    <div id="compass-panel">
      <h4>üìç Page Navigator</h4>
      <div class="location-info" id="location-info">Page ? of ? ‚Ä¢ CFI: ‚Ä¶</div>
      <input type="range" id="page-slider" min="0" max="100" value="0" />
      <input type="text" id="search-input" placeholder="Search text‚Ä¶" />
      <div class="search-results" id="search-results"></div>
    </div>

    <div id="menu-backdrop"></div>
    <div id="expanded-menu">
      <button class="close-menu" onclick="toggleMenu('menu')">√ó</button>
      <div id="book-card">
        <img id="cover" alt="Book Cover" />
        <div id="book-title"></div>
        <div id="book-author"></div>
        <div id="contact-image"></div>
      </div>
      <button class="menu-button" onclick="toggleLibrary(true)">Library</button>
    </div>

    <div id="toc-panel"></div>
        <!-- SETTINGS MODAL -->
    <div id="settings-modal">
      <button class="close-settings" onclick="toggleMenu('settings')">√ó</button>
      <h3>Reading Settings</h3>

      <label for="font-switcher">Font</label>
      <select id="font-switcher">
        <option value="-apple-system">San Francisco (System)</option>
        <option value="Helvetica Neue">Helvetica Neue</option>
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Georgia">Georgia</option>
        <option value="OpenDyslexic">OpenDyslexic</option>
      </select>

      <div class="font-size-buttons">
        <button onclick="changeFontSize(-1)">A-</button>
        <button onclick="changeFontSize(1)">A+</button>
      </div>

      <label for="reading-mode">Reading Mode</label>
      <select id="reading-mode">
        <option value="paginated">Page</option>
        <option value="scrolled-doc">Scroll</option>
        <option value="swipe">Swipe</option>
      </select>

      <label for="theme-select">Color Theme</label>
      <select id="theme-select">
        <option value="light">Light</option>
        <option value="sepia">Sepia</option>
        <option value="night">Night</option>
        <option value="matcha">Matcha Green</option>
      </select>
    </div>

    <!-- EPUB VIEWER -->
    <div id="viewer">
      <div id="tap-left"></div>
      <div id="tap-right"></div>
      <!-- Gesture zones enabled only in swipe mode -->
      <div id="gesture-left"></div>
      <div id="gesture-right"></div>
    </div>

    <div id="progress-bar"></div>
    <div id="continue-bar">Continue</div>
  </div>
    <script>
    // === GLOBAL STATE ===
    let lastNonNightTheme = "light";
    let currentBookUrl = "";
    let bookmarks = [];
    let book, rendition;
    let currentFlow = localStorage.getItem("reading-mode") || "swipe";
    let currentFontSize = parseInt(localStorage.getItem("reader-font-size")) || 100;
    let xDown = null, yDown = null;
    let swipeInProgress = false;

    // === COMPASS UI LOGIC ===
    function updateCompassInfo() {
      const loc = rendition?.location?.start;
      if (!loc) return;
      const currentCFI = loc.cfi || "?";
      const page = book?.locations?.locationFromCfi(currentCFI) || "?";
      const total = book?.locations?.length() || "?";
      document.getElementById("location-info").textContent = `Page ${page} of ${total} ‚Ä¢ CFI: ${currentCFI}`;
      document.getElementById("page-slider").value = Math.floor((page / total) * 100) || 0;
    }

    function jumpToPage(percent) {
      const total = book?.locations?.length();
      if (!total) return;
      const cfi = book.locations.cfiFromPercentage(percent / 100);
      if (rendition && cfi) rendition.display(cfi);
    }

    document.getElementById("compass-toggle").addEventListener("click", () => {
      document.getElementById("compass-panel").classList.toggle("open");
    });

    document.getElementById("page-slider").addEventListener("input", (e) => {
      const value = parseInt(e.target.value, 10);
      jumpToPage(value);
    });

    // === SEARCH ===
    let lunrIndex = null;
    let chapters = [];

    document.getElementById("search-input").addEventListener("input", function () {
      const q = this.value.trim();
      const resultsDiv = document.getElementById("search-results");
      resultsDiv.innerHTML = "";
      if (!q || !lunrIndex) return;
      const results = lunrIndex.search(q);
      results.forEach(res => {
        const item = chapters.find(c => c.id === res.ref);
        if (item) {
          const div = document.createElement("div");
          div.textContent = item.text.slice(0, 120) + "...";
          div.addEventListener("click", () => {
            rendition.display(item.cfi);
            document.getElementById("compass-panel").classList.remove("open");
          });
          resultsDiv.appendChild(div);
        }
      });
    });
          // === LAZY LOAD + LUNR INDEX CREATION ===
    function lazyBuildIndex() {
      if (!book) return;
      chapters = [];
      lunrIndex = lunr(function () {
        this.ref("id");
        this.field("text");
        let idx = 0;
        book.spine.each((item) => {
          item.load(book.archive).then(doc => {
            const text = doc.body.textContent.trim();
            if (text.length > 50) {
              const cfi = item.cfiBase;
              const id = "chap_" + idx++;
              chapters.push({ id, text, cfi });
              this.add({ id, text });
            }
          });
        });
      });
    }

    // === FONT FIX FOR OPENDYSLEXIC ===
    function applyFontSwitch() {
      const font = localStorage.getItem("reader-font") || "-apple-system";
      document.getElementById("font-switcher").value = font;
      if (!rendition) return;

      if (font === "OpenDyslexic") {
        const styleTag = document.createElement("style");
        styleTag.innerHTML = `
          @font-face {
            font-family: "OpenDyslexic";
            src: url("/fonts/OpenDyslexic-Regular.otf") format("opentype");
            font-weight: normal;
          }
          @font-face {
            font-family: "OpenDyslexic";
            src: url("/fonts/OpenDyslexic-Bold.otf") format("opentype");
            font-weight: bold;
          }
          body { font-family: "OpenDyslexic", sans-serif !important; }
        `;
        rendition.getContents().forEach(contents => {
          const doc = contents.document;
          if (!doc.getElementById("OpenDyslexicStyle")) {
            const copy = styleTag.cloneNode(true);
            copy.id = "OpenDyslexicStyle";
            doc.head.appendChild(copy);
          }
        });
      } else {
        rendition.themes.override("body", {
          "font-family": font + ", serif !important"
        });
      }
    }

    document.getElementById("font-switcher").addEventListener("change", function (e) {
      localStorage.setItem("reader-font", e.target.value);
      applyFontSwitch();
    });
          // === INIT BOOK ===
    function initBook(epubUrl) {
      currentBookUrl = epubUrl;
      book = ePub(epubUrl);
      rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        flow: currentFlow === "scrolled-doc" ? "scrolled" : "paginated",
        snap: currentFlow !== "scrolled-doc",
        spread: "always",
        direction: "ltr"
      });

      rendition.display(localStorage.getItem("last-location-" + epubUrl) || undefined);
      book.ready.then(() => {
        book.locations.generate(1600).then(() => {
          updateCompassInfo();
        });
        lazyBuildIndex();
      });

      book.loaded.metadata.then(meta => {
        document.getElementById("book-title").textContent = meta.title || "Untitled";
        document.getElementById("book-author").textContent = meta.creator || "";
      });

      book.loaded.cover
        .then(url => book.archive.createUrl(url, { base64: true }))
        .then(cover => { document.getElementById("cover").src = cover; })
        .catch(() => console.warn("No cover."));

      rendition.on("relocated", (location) => {
        localStorage.setItem("last-location-" + epubUrl, location?.start?.cfi || "");
        updateCompassInfo();
      });

      rendition.on("rendered", () => {
        applyFontSwitch();
        updateCompassInfo();
      });

      applyFontSwitch();
    }

    // === MENU CONTROLS ===
    let openMenuType = null;
    function toggleMenu(type) {
      if (openMenuType === type) return closeMenus();
      closeMenus();
      if (type === 'menu') {
        document.getElementById("expanded-menu").classList.add("open");
        document.getElementById("menu-backdrop").style.display = "block";
      } else if (type === 'settings') {
        document.getElementById("settings-modal").classList.add("open");
      }
      openMenuType = type;
    }
    function closeMenus() {
      document.getElementById("expanded-menu").classList.remove("open");
      document.getElementById("settings-modal").classList.remove("open");
      document.getElementById("menu-backdrop").style.display = "none";
      openMenuType = null;
    }
          // === THEME LOGIC ===
    function changeTheme(theme) {
      document.body.className = "";
      if (theme === "night") {
        document.body.classList.add("night-mode");
      } else if (theme === "sepia") {
        document.body.classList.add("sepia-mode");
      } else if (theme === "matcha") {
        document.body.classList.add("matcha-mode");
      } else {
        document.body.classList.add("light-mode");
      }
      document.getElementById("theme-toggle").textContent = theme === "night" ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("reader-theme", theme);
      document.getElementById("theme-select").value = theme;
    }

    document.getElementById("theme-toggle").addEventListener("click", () => {
      if (document.body.classList.contains("night-mode")) {
        changeTheme(lastNonNightTheme);
      } else {
        lastNonNightTheme = document.getElementById("theme-select").value;
        changeTheme("night");
      }
    });

    document.getElementById("theme-select").addEventListener("change", (e) => {
      changeTheme(e.target.value);
    });

    // === CONTINUE BAR LOGIC ===
    document.getElementById("continue-bar").addEventListener("click", () => {
      if (!rendition) return;
      const loc = rendition.currentLocation();
      const idx = loc?.start?.index || 0;
      const nextItem = book.spine.get(idx + 1);
      if (nextItem) rendition.display(nextItem.href);
    });

    // === INIT ON LOAD ===
    const urlParams = new URLSearchParams(window.location.search);
    const bookParam = urlParams.get("book");
    const lastSavedBook = localStorage.getItem("last-book");
    const theBookUrl = bookParam || lastSavedBook;
    if (theBookUrl) {
      initBook(theBookUrl);
    }
    const savedTheme = localStorage.getItem("reader-theme") || "light";
    document.getElementById("theme-select").value = savedTheme;
    changeTheme(savedTheme);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern E-Reader with Text Selection</title>
    <style>
        :root {
            --font-size: a18px;
            --line-height: 1.8;
            --primary-color: #4361ee;
            --primary-light: rgba(67, 97, 238, 0.1);
            --primary-medium: rgba(67, 97, 238, 0.2);
            --text-color: #333;
            --bg-color: #fff;
            --container-bg: #f8f9fa;
            --highlight-color: #FFEB3B;
            --highlight-bg: rgba(255, 235, 59, 0.3);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .e-reader {
            position: relative;
            width: 100%;
            height: auto;
            min-height: 600px;
            margin: 0 auto;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            padding: 40px;
            font-size: var(--font-size);
            line-height: var(--line-height);
            color: var(--text-color);
            transition: all 0.3s ease;
            user-select: text; /* Enable text selection */
        }
        
        .e-reader p {
            margin-bottom: 20px;
            transition: font-size 0.3s ease;
            position: relative;
        }
        
        /* Text selection style */
        .e-reader ::selection {
            background-color: var(--highlight-bg);
            color: var(--text-color);
        }
        
        .user-highlight {
            background-color: var(--highlight-bg);
            border-radius: 2px;
            padding: 0 2px;
            margin: 0 -2px;
            position: relative;
        }
        
        .user-highlight.has-note:after {
            content: "üìù";
            font-size: 10px;
            position: absolute;
            right: -4px;
            top: -8px;
            color: var(--primary-color);
        }
        
        .toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background-color: var(--bg-color);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            gap: 10px;
            transition: background-color 0.3s;
        }
        
        .toolbar button {
            padding: 10px 16px;
            cursor: pointer;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .toolbar button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .toolbar button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .toolbar .zoom-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .toolbar .zoom-level {
            font-weight: 600;
            margin: 0 5px;
            min-width: 24px;
            text-align: center;
        }
        
        .icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        
        .selection-toolbar {
            position: absolute;
            background-color: var(--bg-color);
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 6px 12px;
            display: flex;
            gap: 8px;
            z-index: 200;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .selection-toolbar.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .selection-toolbar button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        
        .selection-toolbar button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Note popup */
        .note-popup {
            position: absolute;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            width: 240px;
            z-index: 201;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .note-popup.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .note-popup textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            margin-bottom: 8px;
        }
        
        .note-popup .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .note-popup button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .note-popup button.cancel {
            background-color: #ccc;
        }
        
        .note-popup button:hover {
            opacity: 0.9;
        }
        
        /* Highlights panel - similar to bookmark panel */
        #highlights-panel {
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            height: 70vh;
            overflow-y: auto;
            background: rgba(0,0,0,0.85);
            border-bottom: 1px solid #444;
            z-index: 1000;
            transition: transform 0.3s ease;
            transform: translateY(-100%);
        }
        
        #highlights-panel.open {
            transform: translateY(0);
        }
        
        #highlights-panel .highlight-item {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            color: #fff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #highlights-panel .highlight-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        #highlights-panel .highlight-text {
            flex: 1;
            margin-right: 10px;
        }
        
        #highlights-panel .highlight-note {
            font-style: italic;
            margin-top: 5px;
            color: #ccc;
            font-size: 0.9em;
        }
        
        #highlights-panel .highlight-actions {
            display: flex;
            gap: 5px;
        }
        
        #highlights-panel .highlight-actions button {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        #highlights-panel .highlight-actions button:hover {
            opacity: 1;
        }
        
        /* Dark mode toggle */
        .dark-mode {
            --container-bg: #121212;
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-light: rgba(67, 97, 238, 0.2);
            --primary-medium: rgba(67, 97, 238, 0.3);
            --highlight-bg: rgba(255, 235, 59, 0.2);
        }
        
        .dark-mode .toolbar,
        .dark-mode .selection-toolbar,
        .dark-mode .note-popup {
            background-color: #2d2d2d;
        }
        
        .dark-mode .toolbar button,
        .dark-mode .selection-toolbar button {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        
        .dark-mode .toolbar button:hover,
        .dark-mode .selection-toolbar button:hover {
            background-color: #3d3d3d;
        }
        
        .dark-mode .toolbar button.active {
            background-color: #3a56e4;
        }
        
        .dark-mode .note-popup textarea {
            background-color: #333;
            color: #eee;
            border-color: #555;
        }
        
        .dark-mode .note-popup button.cancel {
            background-color: #555;
        }
        
        /* Line height adjustment for readability */
        .line-height-1 { --line-height: 1.5; }
        .line-height-2 { --line-height: 1.8; }
        .line-height-3 { --line-height: 2.1; }
        
        /* Animation for highlighting */
        @keyframes flash-highlight {
            0% { background-color: var(--primary-light); }
            50% { background-color: var(--primary-medium); }
            100% { background-color: var(--highlight-bg); }
        }
        
        .highlight-animation {
            animation: flash-highlight 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="e-reader" id="reader">
            <p>The old man had lived in the valley for over forty years. He knew every tree, every stream, and every shift in the wind. As the sun rose over the eastern mountains, casting long shadows across the fields, he sat on his porch watching the day unfold with the patience of someone who had seen thousands of such mornings.</p>
            
            <p>Nature had been his companion, his teacher, and sometimes his adversary. Through floods and droughts, through harsh winters and brilliant springs, he had observed the rhythms of the land. His weathered hands told stories of hard work, of coaxing life from the soil, of building and repairing what storms had damaged.</p>
            
            <p>The village down in the valley had grown over the decades. What once was a handful of families was now a bustling community with paved roads and streetlights that dimmed the stars he loved to watch. Progress, they called it. He didn't mind the changes, though sometimes he missed the deeper silence of the past.</p>
            
            <p>Children from the village would occasionally venture up to his cabin, curious about the old man who lived alone on the hillside. He would tell them stories of the valley before they were born, of great snowstorms that buried the world in white, of the time the river jumped its banks and reshaped the valley floor. They listened with wide eyes, unable to imagine the landscape as anything different from what they knew.</p>
            
            <p>Today, as he rocked gently in his chair, he noticed a young family making their way up the path toward his home. New faces, he thought, newcomers to the valley. He smiled, ready to welcome them, to share what he knew, to become part of their story as they became part of his.</p>
        </div>
    </div>
    
    <div class="selection-toolbar" id="selection-toolbar">
        <button id="highlight-btn"><span class="icon">üñåÔ∏è</span> Highlight</button>
        <button id="note-btn"><span class="icon">üìù</span> Note</button>
        <button id="clear-btn"><span class="icon">‚ùå</span></button>
    </div>
    
    <div class="note-popup" id="note-popup">
        <textarea id="note-text" placeholder="Add a note..."></textarea>
        <div class="buttons">
            <button class="cancel" id="cancel-note">Cancel</button>
            <button id="save-note">Save</button>
        </div>
    </div>
    
    <!-- Highlights panel (similar to bookmark panel) -->
    <div id="highlights-panel"></div>
    
    <div class="toolbar" id="toolbar">
        <button id="toggle-highlight" class="toggle-button">
            <span class="icon">üñåÔ∏è</span> Highlight
        </button>
        <button id="view-highlights">
            <span class="icon">üîç</span> Highlights
        </button>
        <div class="zoom-controls">
            <button id="decrease-font">
                <span class="icon">A-</span>
            </button>
            <span class="zoom-level" id="font-display">100%</span>
            <button id="increase-font">
                <span class="icon">A+</span>
            </button>
        </div>
        <button id="toggle-spacing">
            <span class="icon">‚ÜïÔ∏è</span> Spacing
        </button>
        <button id="toggle-dark-mode">
            <span class="icon">üåô</span> Dark
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const body = document.body;
            const reader = document.getElementById('reader');
            const paragraphs = reader.querySelectorAll('p');
            const toggleHighlightButton = document.getElementById('toggle-highlight');
            const viewHighlightsButton = document.getElementById('view-highlights');
            const increaseFontButton = document.getElementById('increase-font');
            const decreaseFontButton = document.getElementById('decrease-font');
            const fontDisplay = document.getElementById('font-display');
            const toggleSpacingButton = document.getElementById('toggle-spacing');
            const darkModeToggle = document.getElementById('toggle-dark-mode');
            const selectionToolbar = document.getElementById('selection-toolbar');
            const highlightBtn = document.getElementById('highlight-btn');
            const noteBtn = document.getElementById('note-btn');
            const clearBtn = document.getElementById('clear-btn');
            const notePopup = document.getElementById('note-popup');
            const noteText = document.getElementById('note-text');
            const saveNoteBtn = document.getElementById('save-note');
            const cancelNoteBtn = document.getElementById('cancel-note');
            const highlightsPanel = document.getElementById('highlights-panel');
            
            // State
            let highlightModeEnabled = false;
            let fontSizePercent = 100;
            let spacingLevel = 2; // 1-3
            let highlights = [];
            let lastSelectionRange = null;
            let currentHighlightId = null;
            
            // Initialize
            updateFontSize();
            loadHighlights();
            
            // Toggle highlight mode
            toggleHighlightButton.addEventListener('click', function() {
                highlightModeEnabled = !highlightModeEnabled;
                toggleHighlightButton.classList.toggle('active');
            });
            
            // View highlights
            viewHighlightsButton.addEventListener('click', function() {
                toggleHighlightsPanel();
            });
            
            // Increase font size
            increaseFontButton.addEventListener('click', function() {
                if (fontSizePercent < 200) {
                    fontSizePercent += 10;
                    updateFontSize();
                }
            });
            
            // Decrease font size
            decreaseFontButton.addEventListener('click', function() {
                if (fontSizePercent > 70) {
                    fontSizePercent -= 10;
                    updateFontSize();
                }
            });
            
            // Toggle spacing
            toggleSpacingButton.addEventListener('click', function() {
                spacingLevel = (spacingLevel % 3) + 1;
                
                // Remove all current line height classes
                reader.classList.remove('line-height-1', 'line-height-2', 'line-height-3');
                
                // Add the appropriate class
                reader.classList.add(`line-height-${spacingLevel}`);
                
                // Update button label
                const spacingLabels = ['Compact', 'Normal', 'Relaxed'];
                toggleSpacingButton.innerHTML = `<span class="icon">‚ÜïÔ∏è</span> ${spacingLabels[spacingLevel - 1]}`;
            });
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', function() {
                body.classList.toggle('dark-mode');
                darkModeToggle.classList.toggle('active');
                if (body.classList.contains('dark-mode')) {
                    darkModeToggle.innerHTML = '<span class="icon">‚òÄÔ∏è</span> Light';
                } else {
                    darkModeToggle.innerHTML = '<span class="icon">üåô</span> Dark';
                }
            });
            
            // Update font size
            function updateFontSize() {
                document.documentElement.style.setProperty('--font-size', `${(18 * fontSizePercent / 100)}px`);
                fontDisplay.textContent = `${fontSizePercent}%`;
            }
            
            // Selection handling
            document.addEventListener('selectionchange', function() {
                const selection = window.getSelection();
                
                if (selection.toString().trim().length > 0 && highlightModeEnabled) {
                    // Save the selection range
                    lastSelectionRange = selection.getRangeAt(0).cloneRange();
                    
                    // Get the bounding rectangle of the selection
                    const rect = lastSelectionRange.getBoundingClientRect();
                    
                    // Position the toolbar
                    selectionToolbar.style.left = `${(rect.left + rect.right) / 2 - selectionToolbar.offsetWidth / 2}px`;
                    selectionToolbar.style.top = `${rect.top - selectionToolbar.offsetHeight - 10}px`;
                    
                    // Show the toolbar
                    selectionToolbar.classList.add('visible');
                } else {
                    // Hide the toolbar after a brief delay (to allow button clicks)
                    setTimeout(() => {
                        if (selection.toString().trim().length === 0) {
                            selectionToolbar.classList.remove('visible');
                        }
                    }, 100);
                }
            });
            
            // When user clicks outside, hide the selection toolbar
            document.addEventListener('click', function(e) {
                if (!selectionToolbar.contains(e.target) && 
                    !notePopup.contains(e.target) &&
                    !e.target.closest('#reader') &&
                    window.getSelection().toString().trim().length === 0) {
                    selectionToolbar.classList.remove('visible');
                    notePopup.classList.remove('visible');
                }
            });
            
            // Highlight button
            highlightBtn.addEventListener('click', function() {
                if (lastSelectionRange) {
                    const highlightSpan = createHighlight(lastSelectionRange);
                    
                    if (highlightSpan) {
                        // Show the note popup after a short delay
                        setTimeout(() => {
                            const rect = highlightSpan.getBoundingClientRect();
                            notePopup.style.left = `${rect.left}px`;
                            notePopup.style.top = `${rect.bottom + 10}px`;
                            noteText.value = '';
                            currentHighlightId = highlightSpan.dataset.highlightId;
                            notePopup.classList.add('visible');
                            noteText.focus();
                        }, 100);
                    }
                    
                    window.getSelection().removeAllRanges();
                    selectionToolbar.classList.remove('visible');
                }
            });
            
            // Note button
            noteBtn.addEventListener('click', function() {
                if (lastSelectionRange) {
                    const highlightSpan = createHighlight(lastSelectionRange);
                    
                    if (highlightSpan) {
                        // Position and show note popup
                        const rect = highlightSpan.getBoundingClientRect();
                        notePopup.style.left = `${rect.left}px`;
                        notePopup.style.top = `${rect.bottom + 10}px`;
                        noteText.value = '';
                        currentHighlightId = highlightSpan.dataset.highlightId;
                        notePopup.classList.add('visible');
                        noteText.focus();
                    }
                    
                    window.getSelection().removeAllRanges();
                    selectionToolbar.classList.remove('visible');
                }
            });
            
            // Save note button
            saveNoteBtn.addEventListener('click', function() {
                const note = noteText.value.trim();
                if (currentHighlightId) {
                    const index = highlights.findIndex(h => h.id === currentHighlightId);
                    if (index !== -1) {
                        highlights[index].note = note;
                        saveHighlights();
                        updateHighlightUI();
                        
                        // Add visual indicator that this highlight has a note
                        const highlightSpan = document.querySelector(`[data-highlight-id="${currentHighlightId}"]`);
                        if (highlightSpan && note) {
                            highlightSpan.classList.add('has-note');
                        } else if (highlightSpan && !note) {
                            highlightSpan.classList.remove('has-note');
                        }
                    }
                }
                notePopup.classList.remove('visible');
                currentHighlightId = null;
            });
            
            // Cancel note button
            cancelNoteBtn.addEventListener('click', function() {
                notePopup.classList.remove('visible');
                currentHighlightId = null;
            });
            
            // Clear button - Clear selection
            clearBtn.addEventListener('click', function() {
                window.getSelection().removeAllRanges();
                selectionToolbar.classList.remove('visible');
            });
            
            // Create highlight from selection
            function createHighlight(range) {
                // Create span element for highlight
                const highlightSpan = document.createElement('span');
                highlightSpan.className = 'user-highlight highlight-animation';
                
                // Set unique ID for the highlight
                const highlightId = 'highlight-' + Date.now();
                highlightSpan.dataset.highlightId = highlightId;
                
                // Surround the selected content with the highlight span
                try {
                    range.surroundContents(highlightSpan);
                    
                    // Add the highlight to our list with empty note initially
                    highlights.push({
                        id: highlightId,
                        text: highlightSpan.textContent,
                        note: '',
                        timestamp: Date.now()
                    });
                    
                    saveHighlights();
                    return highlightSpan;
                } catch (e) {
                    console.error('Could not highlight selection: ', e);
                    // Handle complex selections (when selection spans multiple nodes)
                    alert('Please select text within a single paragraph for highlighting');
                    return null;
                }
            }
            
            // Save and load highlights from localStorage
            function saveHighlights() {
                localStorage.setItem('user-highlights', JSON.stringify(highlights));
            }
            
            function loadHighlights() {
                const stored = localStorage.getItem('user-highlights');
                if (stored) {
                    highlights = JSON.parse(stored);
                    updateHighlightUI();
                }
            }
            
            // Update highlights panel UI
            function updateHighlightUI() {
                const panel = document.getElementById('highlights-panel');
                panel.innerHTML = '';
                
                if (highlights.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'highlight-item';
                    emptyMsg.textContent = 'No highlights yet.';
                    panel.appendChild(emptyMsg);
                    return;
                }
                
                // Sort highlights by timestamp (newest first)
                const sortedHighlights = [...highlights].sort((a, b) => b.timestamp - a.timestamp);
                
                sortedHighlights.forEach(highlight => {
                    const item = document.createElement('div');
                    item.className = 'highlight-item';
                    
                    const textDiv = document.createElement('div');
                    textDiv.className = 'highlight-text';
                    textDiv.textContent = `"${highlight.text}"`;
                    
                    if (highlight.note) {
                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'highlight-note';
                        noteDiv.textContent = highlight.note;
                        textDiv.appendChild(noteDiv);
                    }
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'highlight-actions';
                    
                    // Edit note button
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '‚úèÔ∏è';
                    editBtn.title = 'Edit Note';
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editHighlightNote(highlight.id);
                    });
                    
                    // Delete highlight button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = 'üóëÔ∏è';
                    deleteBtn.title = 'Delete Highlight';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteHighlight(highlight.id);
                    });
                    
                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);
                    
                    item.appendChild(textDiv);
                    item.appendChild(actionsDiv);
                    
                    // Click on highlight to jump to it
                    item.addEventListener('click', () => {
                        jumpToHighlight(highlight.id);
                        toggleHighlightsPanel();
                    });
                    
                    panel.appendChild(item);
                });
            }
            
            // Toggle highlights panel visibility
            function toggleHighlightsPanel() {
                highlightsPanel.classList.toggle('open');
            }
            
            // Edit a highlight's note
            function editHighlightNote(id) {
                const highlight = highlights.find(h => h.id === id);
                if (highlight) {
                    const span = document.querySelector(`[data-highlight-id="${id}"]`);
                    if (span) {
                        const rect = span.getBoundingClientRect();
                        notePopup.style.left = `${rect.left}px`;
                        notePopup.style.top = `${rect.bottom + 10}px`;
                        noteText.value = highlight.note || '';
                        currentHighlightId = id;
                        notePopup.classList.add('visible');
                        noteText.focus();
                    }
                }
            }
            
            // Delete a highlight
            function deleteHighlight(id) {
                const index = highlights.findIndex(h => h.id === id);
                if (index !== -1) {
                    highlights.splice(index, 1);
                    saveHighlights();
                    
                    // Remove the highlight span from the DOM
                    const span = document.querySelector(`[data-highlight-id="${id}"]`);
                    if (span) {
                        // Replace the span with its text content
                        const textNode = document.createTextNode(span.textContent);
                        span.parentNode.replaceChild(textNode, span);
                    }
                    
                    updateHighlightUI();
                }
            }
            
            // Jump to a highlight in the text
            function jumpToHighlight(id) {
                const span = document.querySelector(`[data-highlight-id="${id}"]`);
                if (span) {
                    span.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Flash animation to make it obvious where we jumped to
                    span.classList.remove('highlight-animation');
                    void span.offsetWidth; // Force reflow
                    span.classList.add('highlight-animation');
                }
            }
            
            // Initialize touch-to-select on mobile devices
            let touchStartNode = null;
            let touchStartOffset = 0;
            
            // Handle touch start
            reader.addEventListener('touchstart', function(e) {
                if (!highlightModeEnabled) return;
                
                // Prevent default behavior to enable custom selection
                e.preventDefault();
                
                const touch = e.touches[0];
                const range = document.caretRangeFromPoint(touch.clientX, touch.clientY);
                
                if (range) {
                    touchStartNode = range.startContainer;
                    touchStartOffset = range.startOffset;
                }
            });
            
            // Handle touch end
            reader.addEventListener('touchend', function(e) {
                if (!highlightModeEnabled || !touchStartNode) return;
                
                // Prevent default behavior
                e.preventDefault();
                
                const touch = e.changedTouches[0];
                const range = document.caretRangeFromPoint(touch.clientX, touch.clientY);
                
                if (range) {
                    // Create a new range from start to end touch points
                    const selection = window.getSelection();
                    const newRange = document.createRange();
                    
                    // Determine if we need to swap start and end based on direction
                    if (touchStartNode === range.startContainer && 
                        touchStartOffset > range.startOffset ||
                        touchStartNode !== range.startContainer && 
                        compareNodes(touchStartNode, range.startContainer) > 0) {
                        
                        newRange.setStart(range.startContainer, range.startOffset);
                        newRange.setEnd(touchStartNode, touchStartOffset
                                        );
                    } else {
                        newRange.setStart(touchStartNode, touchStartOffset);
                        newRange.setEnd(range.startContainer, range.startOffset);
                    }
                    
                    // Apply the selection
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                    
                    // Trigger the selection change event
                    const selectionEvent = new Event('selectionchange');
                    document.dispatchEvent(selectionEvent);
                    
                    // Update last selection range
                    lastSelectionRange = newRange.cloneRange();
                }
                
                // Reset touch start
                touchStartNode = null;
            });
            
            // Helper function to compare DOM positions
            function compareNodes(nodeA, nodeB) {
                if (nodeA === nodeB) return 0;
                
                const position = nodeA.compareDocumentPosition(nodeB);
                
                if (position & Node.DOCUMENT_POSITION_FOLLOWING) {
                    return -1; // nodeA is before nodeB
                } else if (position & Node.DOCUMENT_POSITION_PRECEDING) {
                    return 1;  // nodeA is after nodeB
                }
                
                return 0;
            }
            
            // Find the parent paragraph of a text node
            function findParentParagraph(node) {
                while (node && node.nodeName !== 'P') {
                    node = node.parentNode;
                }
                return node;
            }
        });
    </script>
</body>
</html>

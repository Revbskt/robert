<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Highlight Test EPUB</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, maximum-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mark.js/dist/mark.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    #toolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 45px;
      background: #333;
      color: white;
      z-index: 100;
      display: flex;
      align-items: center;
      padding: 0 1rem;
    }
    #toolbar button {
      margin-right: 1rem;
      padding: 6px 12px;
      font-size: 1rem;
      background: #555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #viewer {
      position: absolute;
      top: 45px;
      left: 0;
      right: 0;
      bottom: 0;
    }
    #tap-left, #tap-right {
      position: absolute;
      top: 45px;
      bottom: 0;
      width: 35%;
      z-index: 10;
    }
    #tap-left { left: 0; }
    #tap-right { right: 0; }
    mark {
      background: yellow;
      color: black;
    }
  </style>
</head>
<body>

  <div id="toolbar">
    <button id="note-btn">üìù</button>
  </div>

  <div id="viewer"></div>
  <div id="tap-left"></div>
  <div id="tap-right"></div>

  <script>
    window.highlightMode = false;

    document.getElementById("note-btn").onclick = () => {
      highlightMode = !highlightMode;
      const btn = document.getElementById("note-btn");
      btn.style.background = highlightMode ? 'orange' : '#555';
      document.getElementById("tap-left").style.pointerEvents = highlightMode ? "none" : "auto";
      document.getElementById("tap-right").style.pointerEvents = highlightMode ? "none" : "auto";
    };

    const book = ePub("https://s3.amazonaws.com/moby-dick/OPS/package.opf");
    const rendition = book.renderTo("viewer", {
      width: "100%",
      height: "100%",
      flow: "paginated",
      method: "iframe",
      allowScriptedContent: true
    });

    // Mark.js highlight logic
    rendition.hooks.content.register(contents => {
      const doc = contents.document;
      const win = contents.window;

      doc.body.style.webkitUserSelect = "text";
      doc.documentElement.style.webkitUserSelect = "text";
      doc.body.style.userSelect = "text";
      doc.documentElement.style.userSelect = "text";

      function runHighlight() {
        if (!highlightMode) return;
        setTimeout(() => {
          const sel = win.getSelection();
          const text = sel.toString().trim();
          if (text.length > 0) {
            try {
              const marker = new Mark(doc.body);
              marker.unmark({
                done: () => marker.mark(text)
              });
            } catch (err) {
              console.error("Highlight error:", err);
            }
          }
          sel.removeAllRanges();
        }, 100);
      }

      doc.addEventListener("touchend", runHighlight, false);
      doc.addEventListener("pointerup", runHighlight, false);
      doc.addEventListener("selectionchange", () => {
        if ("ontouchstart" in window && highlightMode) {
          setTimeout(runHighlight, 100);
        }
      });
    });

    rendition.display();
  </script>
</body>
</html>

<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>ePub Reader</title><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script><script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script><style>html,body{margin:0;padding:0;height:100%;font-family:sans-serif;background:#f5f5f5}body.light-mode{background:#f5f5f5}body.light-mode #toolbar{background:#eee}body.sepia-mode{background:#f4ecd8}body.sepia-mode #toolbar{background:#e7dbc3}body.matcha-mode{background:#C3D8B6}body.matcha-mode #toolbar{background:#B0CFA3}body.night-mode{background:#111!important}body.night-mode #toolbar{background:#222!important}body.night-mode #continue-bar{background:#111!important;color:#eee!important}#reader-container,#library-container{position:relative;width:100%;height:100%}#reader-container{display:none;overflow:hidden}#library-container{display:none;min-height:100vh;background:#f5f5f5;padding:1rem;box-sizing:border-box}h1{text-align:center;margin:0 0 1rem}#library-controls{text-align:center;margin-bottom:1rem}#library{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:1rem}.book{background:#fff;border:1px solid #ddd;padding:.75rem;width:140px;text-align:center;box-shadow:2px 2px 6px rgba(0,0,0,.1);border-radius:6px}.book img{width:100%;height:auto;border-radius:4px}.book h3{font-size:.9rem;margin:.5rem 0 .25rem}.book p{font-size:.8rem;margin:0 0 .5rem;color:#555}.book button{margin:4px 0;padding:6px 12px;border:none;border-radius:4px;background:#007bff;color:#fff;font-size:.8rem;cursor:pointer;transition:background .2s}.book button:hover{background:#0056b3}#toolbar{position:fixed;top:0;left:0;right:0;height:40px;z-index:1002;display:flex;justify-content:space-evenly;align-items:center;padding:0 10px}#toolbar button{width:40px;height:40px;background:0;border:none;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.8;pointer-events:auto}#toolbar button:hover{opacity:1}</style></head><body class="light-mode"><div id="library-container"><h1>📚 Beta Epub Reader 📚</h1><div id="library-controls"><button onclick="toggleLibrary(false)">Back to Reader</button></div><div id="library">Loading books...</div></div><div id="reader-container"><div id="toolbar"><button id="menu-toggle" title="Main Menu">☰</button><button id="toc-toggle" title="Table of Contents">📖</button><button id="bookmark-toggle" title="Toggle Bookmark">☆</button><button id="bookmark-dropdown" title="Bookmarks">🔖</button><button id="settings-toggle" title="Read Settings">Aa</button><button id="theme-toggle" title="Toggle Night Mode">🌙</button></div><div id="bookmark-panel"></div><div id="menu-backdrop"></div><div id="expanded-menu"><button class="close-menu" onclick="toggleMenu('menu')">×</button><div id="book-card"><img id="cover" alt="Book Cover"/><div id="book-title"></div><div id="book-author"></div><div id="contact-image"></div></div><button class="menu-button" onclick="toggleLibrary(true)">Library</button></div><div id="toc-panel"></div><div id="settings-modal"><button class="close-settings" onclick="toggleMenu('settings')">×</button><h3>Reading Settings</h3><label for="font-switcher">Font</label><select id="font-switcher"><option value="-apple-system">San Francisco (System)</option><option value="Helvetica Neue">Helvetica Neue</option><option value="Arial">Arial</option><option value="Courier New">Courier New</option><option value="Georgia">Georgia</option><option value="OpenDyslexic">OpenDyslexic</option></select><div class="font-size-buttons"><button onclick="changeFontSize(-1)">A-</button><button onclick="changeFontSize(1)">A+</button></div><label for="reading-mode">Reading Mode</label><select id="reading-mode"><option value="paginated">Page</option><option value="scrolled-doc">Scroll</option><option value="swipe">Swipe</option></select><label for="theme-select">Color Theme</label><select id="theme-select"><option value="light">Light</option><option value="sepia">Sepia</option><option value="night">Night</option><option value="matcha">Matcha Green</option></select></div><div id="viewer"><div id="tap-left"></div><div id="tap-right"></div><div id="gesture-left"></div><div id="gesture-right"></div></div><div id="progress-bar"></div><div id="continue-bar">Continue</div></div>
<script>
let lastNonNightTheme="light",currentBookUrl="",bookmarks=[],xDown=null,yDown=null,SWIPE_THRESHOLD=20,swipeInProgress=false,currentFontSize=parseInt(localStorage.getItem("reader-font-size"))||100,currentFlow=localStorage.getItem("reading-mode")||"paginated",libraryVisible=!1,book,rendition,openMenuType=null;
const qs=id=>document.getElementById(id),toggleLibrary=e=>{libraryVisible="boolean"==typeof e?e:!libraryVisible,qs("library-container").style.display=libraryVisible?"block":"none",qs("reader-container").style.display=libraryVisible?"none":"block",closeMenus()},loadLibrary=()=>{const e=qs("library");e.textContent="Loading books...",fetch("/ebooks/library.json").then(e=>e.json()).then(t=>{e.innerHTML="",t.forEach(t=>{const n=document.createElement("div");n.className="book",n.innerHTML=`<img src="${t.cover}" alt="Cover of ${t.title}" /><h3>${t.title}</h3><p>${t.author}</p><button onclick="readBook('${t.fileUrl}')">Read</button>`,e.appendChild(n)})}).catch(t=>{console.error("Failed to load library.json:",t),e.textContent="Failed to load book list."})};loadLibrary();
const readBook=e=>{rendition&&currentBookUrl&&rendition.currentLocation()?.start?.cfi&&localStorage.setItem("last-location-"+currentBookUrl,rendition.currentLocation().start.cfi),cleanupReader(),localStorage.setItem("last-book",e);const t=new URLSearchParams(window.location.search);t.set("book",e),window.history.replaceState({},"","?"+t.toString()),initBook(e),toggleLibrary(!1)};
function cleanupReader(){["tap-left","tap-right"].forEach(e=>qs(e)?.removeEventListener("click",e==="tap-left"?tapLeftHandler:tapRightHandler)),["gesture-left","gesture-right"].forEach(e=>qs(e)?.removeEventListener("click",e==="gesture-left"?swipePrev:swipeNext));const e=qs("viewer");e&&(e.removeEventListener("touchstart",handleTouchStart),e.removeEventListener("touchend",handleTouchEnd))}
const tapLeftHandler=()=>"paginated"===currentFlow&&rendition?.prev(),tapRightHandler=()=>"paginated"===currentFlow&&rendition?.next();function initBook(e){if(!e)return;currentBookUrl=e,bookmarks=[],rendition&&(rendition.destroy(),rendition=null),book&&(book.destroy(),book=null),book=ePub(e),registerReaderEvents(),book.ready.then(()=>{initRendition(currentFlow),setTimeout(()=>book.locations.generate(1600),100),book.loaded.metadata.then(e=>{qs("book-title").textContent=e.title||"Untitled",qs("book-author").textContent=e.creator||""}),book.loaded.cover.then(e=>book.archive.createUrl(e,{base64:!0})).then(e=>{qs("cover").src=e}).catch(()=>console.warn("No cover found")),book.loaded.navigation.then(nav=>{const toc=qs("toc-panel");toc.innerHTML="",nav.toc.forEach(item=>{/contents|table of contents/i.test(item.label)||(link=document.createElement("a"),link.textContent=item.label,link.href="#",link.onclick=e=>(e.preventDefault(),rendition.display(item.href),toc.classList.remove("open")),toc.appendChild(link))}),applyFontSwitch(),loadBookmarks()})})}
function initRendition(mode,cfi){rendition=book.renderTo("viewer",{width:"100%",height:"100%",flow:"scrolled-doc"===mode?"scrolled":"paginated",snap:"scrolled-doc"!==mode,spread:"always",direction:"ltr"}),registerHooks();const stored=localStorage.getItem("last-location-"+currentBookUrl);rendition.display(cfi||stored||void 0),rendition.on("relocated",e=>{e?.start?.cfi&&localStorage.setItem("last-location-"+currentBookUrl,e.start.cfi),updateBookmarkStar()}),rendition.on("rendered",()=>{applyThemeStylesFromCurrent(),applyFontSwitch(),updateBookmarkStar()}),updateSwipeListeners()}
function registerReaderEvents(){qs("tap-left").addEventListener("click",tapLeftHandler),qs("tap-right").addEventListener("click",tapRightHandler)}
function applyFontSwitch(){const e=localStorage.getItem("reader-font")||"-apple-system";qs("font-switcher").value=e,rendition&&("OpenDyslexic"===e?(styleEl=document.createElement("style"),styleEl.innerHTML='@font-face{font-family:"OpenDyslexic";src:url("/fonts/OpenDyslexic-Regular.otf") format("opentype");font-weight:normal;font-style:normal}@font-face{font-family:"OpenDyslexic";src:url("/fonts/OpenDyslexic-Bold.otf") format("opentype");font-weight:bold;font-style:normal}body{font-family:"OpenDyslexic",sans-serif!important}',rendition.getContents().forEach(c=>{doc=c.document,doc.getElementById("OpenDyslexicStyle")||((el=styleEl.cloneNode(!0)).id="OpenDyslexicStyle",doc.head.appendChild(el))}))):(rendition.themes.override("body",{"font-family":e+", serif!important"}),rendition.getContents().forEach(c=>{doc=c.document,styleEl=doc.getElementById("fontOverrideStyle")||doc.createElement("style"),styleEl.id="fontOverrideStyle",styleEl.textContent="body{font-family:"+e+", serif!important}",doc.head.appendChild(styleEl)})))}
function updateSwipeListeners(){const v=qs("viewer");"swipe"===currentFlow?(["tap-left","tap-right"].forEach(e=>qs(e).style.pointerEvents="none"),v.addEventListener("touchstart",handleTouchStart),v.addEventListener("touchend",handleTouchEnd),["gesture-left","gesture-right"].forEach(id=>{qs(id).style.pointerEvents="auto",qs(id).addEventListener("click",id==="gesture-left"?swipePrev:swipeNext)})):(
["gesture-left","gesture-right"].forEach(id=>{qs(id).removeEventListener("click",id==="gesture-left"?swipePrev:swipeNext),qs(id).style.pointerEvents="none"}),
["tap-left","tap-right"].forEach(id=>qs(id).style.pointerEvents="auto"),v.removeEventListener("touchstart",handleTouchStart),v.removeEventListener("touchend",handleTouchEnd))}<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ✅ Metadata and links -->
  <meta charset="UTF-8" />
  <title>ePub Reader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

  <!-- ✅ External libraries (epub.js, jszip) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- ✅ INLINE MINIFIED STYLES -->
  <style>
    <!-- 🔽 INSERT PART 1 STYLES HERE -->
  </style>
</head>
<body class="light-mode">
  <!-- ✅ All your UI elements go here -->
  <!-- 🔽 INSERT PART 1 BODY STRUCTURE HERE -->

  <!-- ✅ INLINE MINIFIED SCRIPT -->
  <script>
    <!-- 🔽 INSERT PART 2A, 2B, 2C HERE -->
  </script>
</body>
</html>function handleTouchStart(e){"swipe"===currentFlow&&(xDown=e.touches[0].clientX,yDown=e.touches[0].clientY)}
function handleTouchEnd(e){if("swipe"!==currentFlow||!xDown||!yDown)return;let t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,r=xDown-t,o=yDown-n;Math.abs(r)>Math.abs(o)&&Math.abs(r)>SWIPE_THRESHOLD&&(r>0?swipeNext():swipePrev()),xDown=null,yDown=null}
function swipeNext(){if(swipeInProgress)return;swipeInProgress=!0;const e=qs("viewer");e.classList.add("swipe-transition"),e.style.transform="translateX(-100%)",setTimeout(()=>{rendition.next(),e.classList.remove("swipe-transition"),e.style.transform="",swipeInProgress=!1},300)}
function swipePrev(){if(swipeInProgress)return;swipeInProgress=!0;const e=qs("viewer");e.classList.add("swipe-transition"),e.style.transform="translateX(100%)",setTimeout(()=>{rendition.prev(),e.classList.remove("swipe-transition"),e.style.transform="",swipeInProgress=!1},300)}

function getBookmarkKey(){return"bookmarks_"+currentBookUrl}
function loadBookmarks(){const e=localStorage.getItem(getBookmarkKey());bookmarks=e?JSON.parse(e):[],updateBookmarkUI()}
function saveBookmarks(){localStorage.setItem(getBookmarkKey(),JSON.stringify(bookmarks)),updateBookmarkUI()}
function updateBookmarkStar(){const e=qs("bookmark-toggle"),t=rendition.currentLocation()?.start?.cfi;if(!t)return e.textContent="☆";const n=bookmarks.some(e=>e.cfi===t);e.textContent=n?"★":"☆",e.style.color=n?"blue":"inherit"}
function updateBookmarkUI(){const e=qs("bookmark-panel");e.innerHTML="";const t=document.createDocumentFragment();0===bookmarks.length?(r=document.createElement("div")).textContent="No bookmarks yet.",t.appendChild(r):bookmarks.forEach(n=>{const r=document.createElement("div");r.textContent="Page "+(n.page||"?")+" - "+n.snippet,r.onclick=()=>{rendition.display(n.cfi),toggleBookmarkDropdown()},t.appendChild(r)}),e.appendChild(t)}
function toggleBookmark(){const e=rendition.currentLocation();if(!e?.start?.cfi)return;const t=e.start.cfi,n=bookmarks.findIndex(e=>e.cfi===t);if(-1!==n)bookmarks.splice(n,1);else{let r="";rendition.getContents().forEach(c=>{const d=c.document;r||d?.body?.textContent&&(r=d.body.textContent.trim().substring(0,100)+"...")});const o=e.start.index||"?";bookmarks.push({cfi:t,snippet:r,page:o})}saveBookmarks(),updateBookmarkStar()}
function toggleBookmarkDropdown(){qs("bookmark-panel").classList.toggle("open")}
function toggleMenu(e){openMenuType===e?closeMenus():(closeMenus(),"menu"===e?(qs("expanded-menu").classList.add("open"),qs("menu-backdrop").style.display="block"):"settings"===e&&qs("settings-modal").classList.add("open"),openMenuType=e)}
function closeMenus(){qs("expanded-menu").classList.remove("open"),qs("settings-modal").classList.remove("open"),qs("menu-backdrop").style.display="none",openMenuType=null}
function applyThemeStylesFromCurrent(){if(!rendition)return;let e="#fff",t="#000";document.body.classList.contains("night-mode")?(e="#111",t="#eee"):document.body.classList.contains("sepia-mode")?(e="#f4ecd8",t="#000"):document.body.classList.contains("matcha-mode")?(e="#C3D8B6",t="#000"):document.body.classList.contains("light-mode")&&(e="#f5f5f5",t="#000"),rendition.getContents().forEach(n=>{const r=n.document;r.documentElement.style.background=e,r.body.style.background=e,r.body.style.color=t})}
function changeFontSize(e){currentFontSize=Math.max(60,Math.min(200,currentFontSize+10*e)),localStorage.setItem("reader-font-size",currentFontSize),rendition&&rendition.themes.fontSize(currentFontSize+"%")}
function changeTheme(e){document.body.className="",qs("theme-toggle").textContent="night"===e?"☀️":"🌙",qs("theme-select").value=e,localStorage.setItem("reader-theme",e),applyThemeStylesFromCurrent(),"night"===e?document.body.classList.add("night-mode"):"sepia"===e?document.body.classList.add("sepia-mode"):"matcha"===e?document.body.classList.add("matcha-mode"):document.body.classList.add("light-mode")}

qs("menu-toggle").onclick=()=>{closeMenus(),toggleMenu("menu")};
qs("toc-toggle").onclick=()=>qs("toc-panel").classList.toggle("open");
qs("settings-toggle").onclick=()=>{closeMenus(),toggleMenu("settings")};
qs("theme-toggle").onclick=()=>{closeMenus(),document.body.classList.contains("night-mode")?changeTheme(lastNonNightTheme):(lastNonNightTheme=qs("theme-select").value,changeTheme("night"))};
qs("bookmark-toggle").onclick=toggleBookmark;
qs("bookmark-dropdown").onclick=toggleBookmarkDropdown;
qs("reading-mode").onchange=e=>{const t=e.target.value;localStorage.setItem("reading-mode",t),currentFlow=t;if(!rendition||!book)return;const n=rendition.location?.start?.cfi||localStorage.getItem("last-location-"+currentBookUrl);rendition.destroy(),setTimeout(()=>initRendition(t,n),50)};
qs("theme-select").onchange=e=>changeTheme(e.target.value);
qs("font-switcher").onchange=e=>{localStorage.setItem("reader-font",e.target.value),applyFontSwitch()};
qs("continue-bar").onclick=()=>{if(!rendition||"scrolled-doc"!==currentFlow)return void(rendition&&rendition.next());const e=rendition.currentLocation();if(e?.start?.index!==void 0){const t=book.spine.get(e.start.index+1);t?rendition.display(t.href):console.warn("No next chapter found.")}else console.warn("Invalid current location:",e)};
(function(){const e=new URLSearchParams(window.location.search).get("book")||localStorage.getItem("last-book");e?(qs("reader-container").style.display="block",qs("library-container").style.display="none",initBook(e)):(qs("library-container").style.display="block",qs("reader-container").style.display="none"));const t=localStorage.getItem("reader-theme")||"light";qs("theme-select").value=t,changeTheme(t)})();
</script>

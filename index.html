<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ePub Reader with Highlights</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />

  <style>
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    /* Container styles */
    #app {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Book display */
    #book-content {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: white;
      margin-top: 20px;
      position: relative;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #eee;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .toolbar button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .toolbar button.active {
      background: #ffcc00;
    }

    /* Highlight styles */
    .highlight-yellow {
      background-color: rgba(255, 255, 0, 0.4);
      border-radius: 4px;
      padding: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .highlight-green {
      background-color: rgba(0, 255, 0, 0.25);
      border-radius: 4px;
      padding: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .highlight-blue {
      background-color: rgba(0, 200, 255, 0.25);
      border-radius: 4px;
      padding: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .highlight-pink {
      background-color: rgba(255, 105, 180, 0.25);
      border-radius: 4px;
      padding: 8px;
      margin: 10px 0;
      position: relative;
    }

    /* Paragraph styles */
    p {
      line-height: 1.6;
      margin: 10px 0;
    }

    p.selected {
      border: 2px dashed #666;
      border-radius: 4px;
      padding: 8px;
    }

    /* Highlight Menu */
    #highlight-menu {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      padding: 20px;
      z-index: 1000;
      display: none;
    }

    .highlight-menu-title {
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .color-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
    }

    .color-option.selected {
      border: 3px solid #333;
    }

    #note-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
      height: 80px;
    }

    .highlight-actions {
      display: flex;
      justify-content: space-between;
    }

    .highlight-actions button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #apply-highlight {
      background: #4CAF50;
      color: white;
    }

    #cancel-highlight {
      background: #f5f5f5;
    }

    /* Highlights list */
    #highlights-list {
      margin-top: 30px;
      padding-top: 20px;
      display: none;
    }

    .highlight-item {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .yellow-highlight {
      background-color: rgba(255, 255, 0, 0.2);
      border-left: 4px solid rgba(255, 255, 0, 0.7);
    }
    
    .green-highlight {
      background-color: rgba(0, 255, 0, 0.1);
      border-left: 4px solid rgba(0, 255, 0, 0.7);
    }
    
    .blue-highlight {
      background-color: rgba(0, 200, 255, 0.1);
      border-left: 4px solid rgba(0, 200, 255, 0.7);
    }
    
    .pink-highlight {
      background-color: rgba(255, 105, 180, 0.1);
      border-left: 4px solid rgba(255, 105, 180, 0.7);
    }

    .highlight-text {
      font-style: italic;
    }

    .highlight-note {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
      background: #f9f9f9;
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #ccc;
    }
    
    .delete-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 3px 8px;
      cursor: pointer;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    /* Debugger panel */
    #debug-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      font-size: 12px;
      max-width: 300px;
      max-height: 200px;
      overflow: auto;
      display: none;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>ePub Reader with Highlighting</h1>
    
    <!-- Toolbar -->
    <div class="toolbar">
      <button id="toggle-highlights-btn">View Highlights</button>
      <button id="highlight-mode-toggle">Highlight Mode</button>
    </div>
    
    <!-- Book Content -->
    <div id="book-content">
      <h2>Demo Book</h2>
      <p data-index="0">This is the first paragraph of the demo book. You can tap on this paragraph when highlight mode is active to highlight it.</p>
      <p data-index="1">This is the second paragraph. The highlighting feature works by selecting entire paragraphs, which works well on mobile devices where precise text selection can be difficult.</p>
      <p data-index="2">This is the third paragraph. You can choose from multiple highlight colors and all your highlights will be saved between sessions.</p>
      <p data-index="3">This is another paragraph. Try the highlight button in the toolbar and then tap on this paragraph.</p>
      <p data-index="4">When you activate highlight mode, tapping on any paragraph will select it. A menu will appear with color options.</p>
      <p data-index="5">After selecting a color, click the "Highlight" button to apply the highlight to the paragraph.</p>
      <p data-index="6">You can view all your highlights by clicking the View Highlights button, and you can see your notes in the highlights list.</p>
    </div>
    
    <!-- Highlights List -->
    <div id="highlights-list">
      <h2>My Highlights and Notes</h2>
      <button id="back-to-book-btn" class="toolbar-btn">Back to Book</button>
      <div id="highlights-container">
        <!-- Highlights will be populated here -->
      </div>
    </div>
    
    <!-- Highlight Menu -->
    <div id="highlight-menu">
      <h3 class="highlight-menu-title">Create Highlight</h3>
      <div class="color-options">
        <div class="color-option selected" style="background-color:#ffff00;" data-color="yellow"></div>
        <div class="color-option" style="background-color:#00ff00;" data-color="green"></div>
        <div class="color-option" style="background-color:#00c8ff;" data-color="blue"></div>
        <div class="color-option" style="background-color:#ff69b4;" data-color="pink"></div>
      </div>
      <label for="note-input">Add a note (optional):</label>
      <textarea id="note-input" placeholder="Enter your note here..."></textarea>
      <div class="highlight-actions">
        <button id="apply-highlight">Save Highlight</button>
        <button id="cancel-highlight">Cancel</button>
      </div>
    </div>
    
    <!-- Debug Panel -->
    <div id="debug-panel"></div>
  </div>

  <script>
    // DOM Elements
    const bookContent = document.getElementById('book-content');
    const highlightsList = document.getElementById('highlights-list');
    const highlightsContainer = document.getElementById('highlights-container');
    const toggleHighlightsBtn = document.getElementById('toggle-highlights-btn');
    const backToBookBtn = document.getElementById('back-to-book-btn');
    const highlightModeToggle = document.getElementById('highlight-mode-toggle');
    const highlightMenu = document.getElementById('highlight-menu');
    const applyHighlightBtn = document.getElementById('apply-highlight');
    const cancelHighlightBtn = document.getElementById('cancel-highlight');
    const noteInput = document.getElementById('note-input');
    const colorOptions = document.querySelectorAll('.color-option');
    const paragraphs = document.querySelectorAll('#book-content p');
    const debugPanel = document.getElementById('debug-panel');
    
    // Global Variables
    let highlightMode = false;
    let selectedParagraph = null;
    let selectedColor = "yellow";
    let highlights = []; // Will store all highlights
    
    // Load highlights from localStorage if they exist
    if (localStorage.getItem('bookHighlights')) {
      try {
        highlights = JSON.parse(localStorage.getItem('bookHighlights'));
        log('Loaded highlights from storage: ' + highlights.length);
      } catch (e) {
        log('Error loading highlights: ' + e.message);
        highlights = [];
        localStorage.removeItem('bookHighlights');
      }
    }
    
    // Debug logging function
    function log(message) {
      console.log(message);
      // Uncomment for visual debugging
      // debugPanel.style.display = 'block';
      // debugPanel.innerHTML += message + '<br>';
    }
    
    // Show toast notification
    function showToast(message, duration = 3000) {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      });
      
      // Create new toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Auto-remove after duration
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, duration);
    }
    
    // Toggle highlight mode
    highlightModeToggle.addEventListener('click', () => {
      highlightMode = !highlightMode;
      highlightModeToggle.classList.toggle('active');
      
      if (highlightMode) {
        showToast('Highlight mode activated. Tap any paragraph to highlight it.');
      } else {
        showToast('Highlight mode deactivated');
        
        // Clear any selected paragraph
        if (selectedParagraph) {
          selectedParagraph.classList.remove('selected');
          selectedParagraph = null;
        }
      }
    });
    
    // Toggle between book and highlights view
    toggleHighlightsBtn.addEventListener('click', () => {
      bookContent.style.display = 'none';
      highlightsList.style.display = 'block';
      updateHighlightsList();
    });
    
    backToBookBtn.addEventListener('click', () => {
      bookContent.style.display = 'block';
      highlightsList.style.display = 'none';
    });
    
    // Setup paragraph selection
    paragraphs.forEach((p) => {
      p.addEventListener('click', () => {
        if (!highlightMode) return;
        
        // Clear previous selection
        if (selectedParagraph) {
          selectedParagraph.classList.remove('selected');
        }
        
        // Select this paragraph
        selectedParagraph = p;
        p.classList.add('selected');
        
        // Show highlight menu
        highlightMenu.style.display = 'block';
        
        // Clear previous note
        noteInput.value = '';
      });
    });
    
    // Color selection
    colorOptions.forEach(option => {
      option.addEventListener('click', () => {
        // Update selected color
        selectedColor = option.getAttribute('data-color');
        
        // Update UI
        colorOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
      });
    });
    
    // Apply highlight
    applyHighlightBtn.addEventListener('click', () => {
      if (!selectedParagraph) return;
      
      // Get paragraph index
      const paragraphIndex = parseInt(selectedParagraph.getAttribute('data-index'));
      
      // Get note text
      const note = noteInput.value.trim();
      
      // Get paragraph text
      const text = selectedParagraph.textContent;
      
      // Apply highlight class
      selectedParagraph.className = `highlight-${selectedColor}`;
      selectedParagraph.classList.remove('selected');
      
      // Create highlight object
      const highlight = {
        id: Date.now(),
        paragraphIndex: paragraphIndex,
        text: text,
        color: selectedColor,
        note: note,
        timestamp: new Date().toISOString()
      };
      
      // Add to highlights array
      highlights.push(highlight);
      
      // Save to localStorage
      localStorage.setItem('bookHighlights', JSON.stringify(highlights));
      
      log('Saved highlight: ' + JSON.stringify(highlight));
      
      // Close highlight menu
      highlightMenu.style.display = 'none';
      
      // Show confirmation
      showToast(note ? 'Highlight and note saved' : 'Highlight saved');
      
      // Clear selected paragraph
      selectedParagraph = null;
    });
    
    // Cancel highlight
    cancelHighlightBtn.addEventListener('click', () => {
      if (selectedParagraph) {
        selectedParagraph.classList.remove('selected');
        selectedParagraph = null;
      }
      
      highlightMenu.style.display = 'none';
    });
    
    // Update highlights list view
    function updateHighlightsList() {
      // Clear the container
      highlightsContainer.innerHTML = '';
      
      log('Updating highlights list with ' + highlights.length + ' highlights');
      
      if (highlights.length === 0) {
        highlightsContainer.innerHTML = '<p>No highlights yet. Use highlight mode to create some!</p>';
        return;
      }
      
      // Sort highlights by paragraph index
      highlights.sort((a, b) => a.paragraphIndex - b.paragraphIndex);
      
      // Add each highlight to the container
      highlights.forEach((highlight, index) => {
        const item = document.createElement('div');
        item.className = `highlight-item ${highlight.color}-highlight`;
        
        // Add text content
        const text = document.createElement('div');
        text.className = 'highlight-text';
        text.textContent = highlight.text;
        item.appendChild(text);
        
        // Add note if present
        if (highlight.note) {
          const noteElem = document.createElement('div');
          noteElem.className = 'highlight-note';
          noteElem.textContent = highlight.note;
          item.appendChild(noteElem);
        }
        
        // Add delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', () => {
          // Remove from array
          highlights = highlights.filter(h => h.id !== highlight.id);
          
          // Save to localStorage
          localStorage.setItem('bookHighlights', JSON.stringify(highlights));
          
          // Remove highlight from paragraph
          if (highlight.paragraphIndex >= 0 && highlight.paragraphIndex < paragraphs.length) {
            paragraphs[highlight.paragraphIndex].className = '';
          }
          
          // Remove from list
          highlightsContainer.removeChild(item);
          
          // Show empty message if needed
          if (highlights.length === 0) {
            highlightsContainer.innerHTML = '<p>No highlights yet. Use highlight mode to create some!</p>';
          }
          
          showToast('Highlight deleted');
        });
        
        item.appendChild(deleteBtn);
        highlightsContainer.appendChild(item);
      });
    }
    
    // Apply saved highlights to paragraphs
    function applyHighlights() {
      log('Applying ' + highlights.length + ' highlights to paragraphs');
      
      highlights.forEach(highlight => {
        if (highlight.paragraphIndex >= 0 && highlight.paragraphIndex < paragraphs.length) {
          const p = paragraphs[highlight.paragraphIndex];
          p.className = `highlight-${highlight.color}`;
        }
      });
    }
    
    // Initialize
    applyHighlights();
  </script>
</body>
</html>

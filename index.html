<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ePub Reader</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />

  <!-- Essential Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    /* All previous styles remain the same */

    /* Highlight Styles */
    .highlight-yellow { background-color: rgba(255,255,0,0.3); }
    .highlight-green { background-color: rgba(0,255,0,0.3); }
    .highlight-pink { background-color: rgba(255,192,203,0.3); }
    .highlight-blue { background-color: rgba(0,0,255,0.3); }
  </style>
</head>
<body>
  <!-- Existing HTML remains the same -->
  
  <script>
    // Existing script remains the same, with these additions:

    // Highlight Mode Variables
    let isHighlightMode = false;
    let currentHighlightColor = 'yellow';
    let highlights = {};

    // Highlight Mode Toggle
    function toggleHighlightMode() {
      isHighlightMode = !isHighlightMode;
      console.log('Highlight mode:', isHighlightMode);
    }

    // Highlight Paragraph
    function highlightParagraph(paragraph) {
      if (!isHighlightMode) return;

      const currentClass = `highlight-${currentHighlightColor}`;
      
      // Toggle highlight
      if (paragraph.classList.contains(currentClass)) {
        paragraph.classList.remove(currentClass);
      } else {
        paragraph.classList.add(currentClass);
      }
    }

    // Modify initRendition to set up highlight listeners
    function initRendition(flowMode) {
      rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        flow: flowMode === "scrolled" ? "scrolled" : "paginated",
        snap: flowMode !== "scrolled"
      });

      // Add highlight listener
      rendition.on('rendered', () => {
        rendition.getContents().forEach(content => {
          const doc = content.document;
          const paragraphs = doc.querySelectorAll('p');
          
          paragraphs.forEach(para => {
            para.addEventListener('click', () => highlightParagraph(para));
          });
        });
      });

      // Default display
      rendition.display();

      // Existing reading mode setup
      setupReadingModeEvents();
    }

    // Add highlight mode toggle to toolbar
    document.getElementById('toolbar').innerHTML += `
      <button id="highlight-mode-toggle">üñçÔ∏è</button>
    `;

    // Add highlight mode toggle event
    document.getElementById('highlight-mode-toggle').addEventListener('click', () => {
      toggleHighlightMode();
    });
  </script>
</body>
</html>

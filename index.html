<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Liars EPUB Highlight Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mark.js/dist/mark.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    #toolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 45px;
      background: #222;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      z-index: 100;
    }
    #toolbar button {
      margin-right: 1rem;
      padding: 6px 12px;
      font-size: 1rem;
      background: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #viewer {
      position: absolute;
      top: 45px; bottom: 0; left: 0; right: 0;
      background: #fff;
    }
    #tap-left, #tap-right {
      position: absolute;
      top: 45px;
      bottom: 0;
      width: 35%;
      z-index: 10;
    }
    #tap-left { left: 0; }
    #tap-right { right: 0; }
    mark {
      background: yellow;
      color: black;
    }
  </style>
</head>
<body>

  <div id="toolbar">
    <button id="highlightToggle">üìù Highlight</button>
  </div>

  <div id="viewer"></div>
  <div id="tap-left"></div>
  <div id="tap-right"></div>

  <script>
    let highlightMode = false;
    const toggleBtn = document.getElementById("highlightToggle");
    const tapLeft = document.getElementById("tap-left");
    const tapRight = document.getElementById("tap-right");

    toggleBtn.addEventListener("click", () => {
      highlightMode = !highlightMode;
      toggleBtn.style.background = highlightMode ? "orange" : "#444";
      tapLeft.style.pointerEvents = highlightMode ? "none" : "auto";
      tapRight.style.pointerEvents = highlightMode ? "none" : "auto";
    });

    const book = ePub("/ebooks/liars.epub");
    const rendition = book.renderTo("viewer", {
      width: "100%",
      height: "100%",
      flow: "paginated",
      manager: "default",
      method: "iframe",
      allowScriptedContent: true
    });

    // Tap navigation
    tapLeft.onclick = () => rendition.prev();
    tapRight.onclick = () => rendition.next();

    // Hook into iframe for selection/highlighting
    rendition.hooks.content.register(contents => {
      const doc = contents.document;
      const win = contents.window;

      doc.body.style.webkitUserSelect = "text";
      doc.documentElement.style.webkitUserSelect = "text";
      doc.body.style.userSelect = "text";
      doc.documentElement.style.userSelect = "text";
      doc.body.style.webkitTouchCallout = "none";

      function runHighlight() {
        if (!highlightMode) return;
        setTimeout(() => {
          const sel = win.getSelection();
          const text = sel.toString().trim();
          if (text.length > 0) {
            try {
              const marker = new Mark(doc.body);
              marker.unmark({ done: () => marker.mark(text) });
            } catch (err) {
              console.error("Highlight error:", err);
            }
          }
          sel.removeAllRanges();
        }, 100);
      }

      doc.addEventListener("touchend", runHighlight, false);
      doc.addEventListener("pointerup", runHighlight, false);
      doc.addEventListener("selectionchange", () => {
        if ("ontouchstart" in window && highlightMode) {
          setTimeout(runHighlight, 100);
        }
      });
    });

    rendition.display();
  </script>
</body>
</html>

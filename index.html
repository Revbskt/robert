
// Update highlights list in the menu
    function updateHighlightsList() {
      const highlightsList = document.getElementById("highlights-list");
      const bookTitle = "Demo Book";
      
      // Clear current list
      highlightsList.innerHTML = "";
      
      // Add each highlight to the list
      if (bookHighlights[bookTitle] && bookHighlights[bookTitle].length > 0) {
        bookHighlights[bookTitle].forEach((highlight, index) => {
          const highlightDiv = document.createElement("div");
          highlightDiv.className = "highlight-item";
          highlightDiv.style.borderLeft = `4px solid ${getColorHex(highlight.color)}`;
          
          // Add text content
          const textSpan = document.createElement("div");
          textSpan.textContent = highlight.text;
          highlightDiv.appendChild(textSpan);
          
          // Add note content if exists
          if (highlight.note) {
            const noteSpan = document.createElement("div");
            noteSpan.className = "highlight-note-indicator";
            noteSpan.textContent = "üìù " + highlight.note;
            highlightDiv.appendChild(noteSpan);
          }
          
          // Add delete option
          const deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "üóëÔ∏è";
          deleteBtn.title = "Delete highlight";
          deleteBtn.style.position = "absolute";
          deleteBtn.style.right = "8px";
          deleteBtn.style.top = "8px";
      <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ePub Reader with Highlights</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />

  <!-- Essential Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    /* Layout Containers */
    #reader-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #library-container {
      position: relative;
      min-height: 100vh;
      background: #f5f5f5;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Library Grid */
    #library {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 1rem;
    }

    .book {
      background: #fff;
      border: 1px solid #ddd;
      padding: 0.75rem;
      width: 140px;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
    }

    .book img { 
      width: 100%; 
      height: auto; 
      border-radius: 4px; 
    }

    .book h3 { 
      font-size: 0.9rem; 
      margin: 0.5rem 0 0.25rem; 
    }

    .book p { 
      font-size: 0.8rem; 
      margin: 0 0 0.5rem; 
      color: #555; 
    }

    .book button {
      margin: 4px 0;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .book button:hover { 
      background-color: #0056b3; 
    }

    /* Viewer and Toolbar */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      z-index: 1002;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      background: #eee;
    }

    #toolbar button {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    #viewer {
      position: absolute;
      top: 40px;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }

    /* Slide-out Menu */
    #menu-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1001;
    }

    #expanded-menu {
      position: fixed;
      top: 0;
      bottom: 0;
      left: -100%;
      width: 80%;
      max-width: 300px;
      background: rgba(128,128,128,0.90);
      color: #fff;
      z-index: 1010;
      display: flex;
      flex-direction: column;
      padding: 20px;
      transition: left 0.3s ease;
    }

    #expanded-menu.open { 
      left: 0; 
    }

    #expanded-menu .close-menu {
      align-self: flex-end;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #fff;
    }

    /* Scrolling and Swiping Support */
    .reading-zone {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      z-index: 998;
    }

    #reading-left { left: 0; }
    #reading-right { right: 0; }

    /* Highlight Styles */
    .highlight-yellow {
      background-color: rgba(255, 255, 0, 0.4) !important;
      box-shadow: 0 0 0 2px rgba(255, 255, 0, 0.6) !important;
      border-radius: 4px !important;
      padding: 4px !important;
      margin: 4px 0 !important;
      position: relative;
    }

    .highlight-green {
      background-color: rgba(0, 255, 0, 0.25) !important;
      box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.4) !important;
      border-radius: 4px !important;
      padding: 4px !important;
      margin: 4px 0 !important;
      position: relative;
    }

    .highlight-blue {
      background-color: rgba(0, 200, 255, 0.25) !important;
      box-shadow: 0 0 0 2px rgba(0, 200, 255, 0.4) !important;
      border-radius: 4px !important;
      padding: 4px !important;
      margin: 4px 0 !important;
      position: relative;
    }

    .highlight-pink {
      background-color: rgba(255, 105, 180, 0.25) !important;
      box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.4) !important;
      border-radius: 4px !important;
      padding: 4px !important;
      margin: 4px 0 !important;
      position: relative;
    }
    
    /* Note indicator */
    .has-note:after {
      content: "üìù";
      position: absolute;
      right: -5px;
      top: 0;
      font-size: 14px;
    }
    
    /* Note display */
    .note-display {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      margin-top: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      width: 90%;
      left: 5%;
      font-size: 14px;
    }
    
    /* Highlight controls */
    .highlight-controls {
      display: none;
      position: absolute;
      right: -30px;
      top: 0;
      font-size: 16px;
    }
    
    .highlight-controls button {
      background: none;
      border: none;
      cursor: pointer;
      margin: 2px;
      padding: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Make highlight interactive */
    .highlight-yellow:hover .highlight-controls,
    .highlight-green:hover .highlight-controls,
    .highlight-blue:hover .highlight-controls,
    .highlight-pink:hover .highlight-controls {
      display: flex;
      flex-direction: column;
    }
    
    /* Note popup styling */
    .note-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1020;
      padding: 15px;
      width: 85%;
      max-width: 350px;
    }
    
    .note-popup textarea {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    
    .note-popup-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    
    .note-popup button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .note-popup-save {
      background-color: #007bff;
      color: white;
    }
    
    .note-popup-cancel {
      background-color: #eeeeee;
    }
    
    /* Note display in paragraph */
    .note-indicator {
      margin-top: 4px;
      background: rgba(255,255,255,0.5);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
      font-style: italic;
      color: #333;
    }

    /* Highlight Menu */
    #highlight-menu {
      position: fixed;
      display: none;
      z-index: 1015;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      width: 240px;
    }

    .highlight-colors {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      justify-content: center;
    }

    .color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    /* Note textarea */
    #highlight-note {
      width: 100%;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 14px;
      box-sizing: border-box;
      height: 60px;
    }

    #highlight-menu button {
      padding: 5px 12px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      margin-right: 5px;
      cursor: pointer;
    }

    #highlight-menu button:hover {
      background-color: #0056b3;
    }
    
    /* Highlight action buttons */
    .highlight-actions {
      display: flex;
      justify-content: space-between;
    }

    /* Highlight List in Menu */
    #highlights-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .highlight-item {
      padding: 8px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      position: relative;
    }
    
    .highlight-note-indicator {
      font-size: 12px;
      color: #ddd;
      margin-top: 4px;
      font-style: italic;
    }

    .highlight-item:hover {
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
  <!-- Library Container -->
  <div id="library-container">
    <h1>üìö ePub Reader</h1>
    <div id="library">Loading books...</div>
  </div>

  <!-- Reader Container -->
  <div id="reader-container">
    <div id="toolbar">
      <button id="menu-toggle">‚ò∞</button>
      <div>
        <button id="highlight-toggle">üñåÔ∏è</button>
        <button id="reading-mode-toggle">üìñ</button>
      </div>
    </div>

    <!-- Menu Backdrop and Expanded Menu -->
    <div id="menu-backdrop"></div>
    <div id="expanded-menu">
      <button class="close-menu" onclick="toggleMenu('menu')">√ó</button>
      <div id="book-details">
        <h2 id="book-title">Book Title</h2>
        <p id="book-author">Author Name</p>
      </div>
      <button onclick="toggleLibrary(true)">Back to Library</button>
      
      <!-- Highlights Section -->
      <div>
        <h3>Highlights</h3>
        <div id="highlights-list"></div>
      </div>
    </div>

    <!-- Highlight Menu -->
    <div id="highlight-menu">
      <div class="highlight-colors">
        <div class="color-option" style="background-color: #ffff00;" data-color="yellow"></div>
        <div class="color-option" style="background-color: #00ff00;" data-color="green"></div>
        <div class="color-option" style="background-color: #00c8ff;" data-color="blue"></div>
        <div class="color-option" style="background-color: #ff69b4;" data-color="pink"></div>
      </div>
      <textarea id="highlight-note" placeholder="Add a note (optional)"></textarea>
      <div class="highlight-actions">
        <button id="apply-highlight">Highlight</button>
        <button id="cancel-highlight">Cancel</button>
      </div>
    </div>
    
    <!-- Note Popup for Editing -->
    <div id="note-popup" class="note-popup">
      <h3>Edit Note</h3>
      <textarea id="edit-note-text"></textarea>
      <div class="note-popup-actions">
        <button class="note-popup-save" id="save-note">Save</button>
        <button class="note-popup-cancel" id="cancel-note">Cancel</button>
      </div>
    </div>

    <!-- Viewer Area with Reading Zones -->
    <div id="viewer">
      <div id="reading-left" class="reading-zone"></div>
      <div id="reading-right" class="reading-zone"></div>
    </div>
  </div>

  <script>
    // Global Variables
    let book, rendition;
    let currentBookUrl = null;
    let currentFlow = 'paginated';
    let xDown = null, yDown = null;
    const SWIPE_THRESHOLD = 20;
    let swipeInProgress = false;
    let highlightMode = false;
    let selectedColor = "yellow";
    let selectedText = null;
    let selectedCfiRange = null;
    let bookHighlights = {};
    let originalOverflowY = "hidden"; // Store original scroll setting
    let currentNote = ""; // For storing notes
    let activeHighlightElement = null; // Currently active highlight element

    // Library Loading
    function loadLibrary() {
      const libraryDiv = document.getElementById("library");
      // For demo purposes
      const demoBooks = [
        {
          title: "Demo Book 1",
          author: "Demo Author",
          cover: "/api/placeholder/140/200",
          fileUrl: "#demo1"
        },
        {
          title: "Demo Book 2",
          author: "Another Author",
          cover: "/api/placeholder/140/200",
          fileUrl: "#demo2"
        }
      ];
      
      libraryDiv.innerHTML = "";
      demoBooks.forEach(book => {
        const bookDiv = document.createElement("div");
        bookDiv.className = "book";
        bookDiv.innerHTML = `
          <img src="${book.cover}" alt="Cover of ${book.title}" />
          <h3>${book.title}</h3>
          <p>${book.author}</p>
          <button onclick="simulateBookRead('${book.fileUrl}')">Read</button>
        `;
        libraryDiv.appendChild(bookDiv);
      });
    }
    loadLibrary();

    // Simulate book reading for demo
    function simulateBookRead(bookId) {
      currentBookUrl = bookId;
      toggleLibrary(false);
      
      // Create a demo book structure
      const demoContent = `
        <div style="padding: 20px; font-family: serif;">
          <style>
            /* Add iOS-specific styles to help with highlighting */
            body {
              -webkit-touch-callout: default; /* iOS Safari */
              -webkit-user-select: text; /* Safari */
              -webkit-tap-highlight-color: rgba(0,0,0,0); /* Remove tap highlight */
            }
            
            p {
              padding: 8px 0;
              margin: 10px 0;
              line-height: 1.5;
              border-radius: 4px;
              position: relative; /* For positioning controls */
            }
            
            p:active {
              background-color: rgba(200,200,200,0.3);
            }
            
            /* Better highlight styles for demo */
            .highlight-yellow {
              background-color: rgba(255, 255, 0, 0.4) !important;
              box-shadow: 0 0 0 2px rgba(255, 255, 0, 0.6) !important;
              border-radius: 4px !important;
              padding: 4px !important;
              margin: 4px 0 !important;
              position: relative !important;
            }

            .highlight-green {
              background-color: rgba(0, 255, 0, 0.25) !important;
              box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.4) !important;
              border-radius: 4px !important;
              padding: 4px !important;
              margin: 4px 0 !important;
              position: relative !important;
            }

            .highlight-blue {
              background-color: rgba(0, 200, 255, 0.25) !important;
              box-shadow: 0 0 0 2px rgba(0, 200, 255, 0.4) !important;
              border-radius: 4px !important;
              padding: 4px !important;
              margin: 4px 0 !important;
              position: relative !important;
            }

            .highlight-pink {
              background-color: rgba(255, 105, 180, 0.25) !important;
              box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.4) !important;
              border-radius: 4px !important;
              padding: 4px !important;
              margin: 4px 0 !important;
              position: relative !important;
            }
            
            /* Note indicator */
            .has-note:after {
              content: "üìù";
              position: absolute;
              right: -5px;
              top: 0;
              font-size: 14px;
            }
            
            /* Controls for each highlight */
            .highlight-controls {
              display: none;
              position: absolute;
              right: -34px;
              top: 0;
              font-size: 14px;
              flex-direction: column;
            }
            
            .highlight-controls button {
              background: white;
              border: 1px solid #ddd;
              width: 28px;
              height: 28px;
              border-radius: 50%;
              margin: 2px 0;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .highlight-edit {
              color: #0077ff;
            }
            
            .highlight-delete {
              color: #ff3333;
            }
            
            /* Show controls on highlight hover */
            .highlight-yellow:hover .highlight-controls,
            .highlight-green:hover .highlight-controls,
            .highlight-blue:hover .highlight-controls,
            .highlight-pink:hover .highlight-controls {
              display: flex;
            }
            
            /* Note display inside highlight */
            .note-display {
              background: rgba(255,255,255,0.9);
              border-radius: 4px;
              margin-top: 5px;
              padding: 6px 8px;
              font-size: 0.9em;
              font-style: italic;
              color: #555;
              position: relative;
            }
          </style>
          <h1>Demo Book</h1>
          <h2>Chapter 1</h2>
          <p>This is the first paragraph of the demo book. You can tap on this paragraph when highlight mode is active to highlight it.</p>
          <p>This is the second paragraph. The highlighting feature works by selecting entire paragraphs, which works well on mobile devices where precise text selection can be difficult.</p>
          <p>This is the third paragraph. You can choose from multiple highlight colors and all your highlights will be saved between sessions.</p>
          <h2>Chapter 2</h2>
          <p>This is the first paragraph of Chapter 2. Try the highlight button in the toolbar and then tap on this paragraph.</p>
          <p>When you activate highlight mode, tapping on any paragraph will select it. A menu will appear with color options.</p>
          <p>After selecting a color, click the "Highlight" button to apply the highlight to the paragraph.</p>
          <p>You can view all your highlights by clicking the menu button, and you can click on any highlight to jump to that location in the book.</p>
        </div>
      `;
      
      // Create a temporary iframe to simulate the book
      const viewer = document.getElementById("viewer");
      viewer.innerHTML = "";
      const iframe = document.createElement("iframe");
      iframe.style.width = "100%";
      iframe.style.height = "100%";
      iframe.style.border = "none";
      viewer.appendChild(iframe);
      
      // Set content and initialize highlighting
      iframe.contentDocument.open();
      iframe.contentDocument.write(demoContent);
      iframe.contentDocument.close();
      
      // Set up paragraph selection in the iframe
      setupDemoHighlighting(iframe);
      
      // Update book details
      document.getElementById("book-title").textContent = "Demo Book";
      document.getElementById("book-author").textContent = "Demo Author";
      
      // Load any saved highlights
      loadHighlights("Demo Book");
    }
    
    // Setup highlighting for demo
    function setupDemoHighlighting(iframe) {
      const doc = iframe.contentDocument;
      const paragraphs = doc.querySelectorAll("p");
      const viewer = document.getElementById("viewer");
      const readingZones = document.querySelectorAll(".reading-zone");
      
      // Handle highlight toggle
      const highlightToggle = document.getElementById("highlight-toggle");
      highlightToggle.addEventListener("click", () => {
        highlightMode = !highlightMode;
        highlightToggle.style.backgroundColor = highlightMode ? "#ffcc00" : "transparent";
        
        // When highlight mode is active:
        // 1. Disable all tap zones by hiding them
        // 2. Force scroll mode for content
        if (highlightMode) {
          // Disable reading zones (tap areas for page turning)
          readingZones.forEach(zone => {
            zone.style.display = "none";
          });
          
          // Force scroll mode for iframe content
          iframe.style.overflowY = "scroll";
          iframe.style.WebkitOverflowScrolling = "touch"; // Enable momentum scrolling on iOS
          
          // Prevent default iOS text selection behavior
          doc.body.style.webkitTouchCallout = "none";
          doc.body.style.webkitUserSelect = "none";
          doc.body.style.userSelect = "none";
        } else {
          // Re-enable reading zones
          readingZones.forEach(zone => {
            zone.style.display = "block";
          });
          
          // Restore original scroll settings
          iframe.style.overflowY = "hidden";
          
          // Restore text selection behavior
          doc.body.style.webkitTouchCallout = "default";
          doc.body.style.webkitUserSelect = "text";
          doc.body.style.userSelect = "text";
        }
      });
      
      // Setup paragraph selection
      paragraphs.forEach(p => {
        // Use touchend instead of click for better iOS compatibility
        p.addEventListener("touchend", (e) => {
          if (!highlightMode) return;
          
          // Prevent default behavior which can trigger text selection
          e.preventDefault();
          
          // Select the paragraph
          selectedText = p.textContent;
          selectedCfiRange = "demo-cfi-" + Math.random().toString(36).substring(2, 10); // Demo CFI
          
          // Add visual feedback
          paragraphs.forEach(para => para.style.border = "none"); // Reset all
          p.style.border = "2px dashed #666"; // Show selection
          
          // Show highlight menu
          const rect = p.getBoundingClientRect();
          const highlightMenu = document.getElementById("highlight-menu");
          
          // Position menu near paragraph but ensure it's visible on screen
          const menuWidth = 200; // Approximate width of menu
          let leftPos = rect.left + (rect.width/2) - (menuWidth/2);
          
          // Make sure menu doesn't go off screen
          if (leftPos < 10) leftPos = 10;
          if (leftPos + menuWidth > window.innerWidth - 10) 
            leftPos = window.innerWidth - menuWidth - 10;
          
          highlightMenu.style.left = leftPos + "px";
          highlightMenu.style.top = (rect.bottom + 10) + "px";
          highlightMenu.style.display = "block";
          
          // Save the paragraph reference for highlighting
          window.selectedParagraph = p;
        });
        
        // Also handle regular clicks for non-touch devices
        p.addEventListener("click", (e) => {
          if (!highlightMode) return;
          
          // Select the paragraph
          selectedText = p.textContent;
          selectedCfiRange = "demo-cfi-" + Math.random().toString(36).substring(2, 10); // Demo CFI
          
          // Add visual feedback
          paragraphs.forEach(para => para.style.border = "none"); // Reset all
          p.style.border = "2px dashed #666"; // Show selection
          
          // Show highlight menu
          const rect = p.getBoundingClientRect();
          const highlightMenu = document.getElementById("highlight-menu");
          
          highlightMenu.style.left = (rect.left + rect.width/2 - highlightMenu.offsetWidth/2) + "px";
          highlightMenu.style.top = (rect.bottom + 10) + "px";
          highlightMenu.style.display = "block";
          
          // Save the paragraph reference for highlighting
          window.selectedParagraph = p;
        });
      });
      
      // Setup color selection
      const colorOptions = document.querySelectorAll(".color-option");
      colorOptions.forEach(option => {
        option.addEventListener("click", () => {
          selectedColor = option.getAttribute("data-color");
          colorOptions.forEach(opt => opt.style.border = "none");
          option.style.border = "2px solid #000";
        });
      });
      
      // Set default selected color
      document.querySelector('[data-color="yellow"]').style.border = "2px solid #000";
      
      // Apply highlight button
      const applyHighlightBtn = document.getElementById("apply-highlight");
      applyHighlightBtn.addEventListener("click", () => {
        if (selectedText && window.selectedParagraph) {
          // Get the note text
          const noteInput = document.getElementById("highlight-note");
          currentNote = noteInput.value.trim();
          
          // Apply highlight class to paragraph
          window.selectedParagraph.className = "highlight-" + selectedColor;
          if (currentNote) {
            window.selectedParagraph.classList.add("has-note");
          }
          window.selectedParagraph.style.border = "none"; // Remove selection border
          
          // Save highlight with note
          saveHighlight(selectedCfiRange, selectedColor, currentNote);
          
          // Close menu and reset note field
          document.getElementById("highlight-menu").style.display = "none";
          noteInput.value = "";
          
          // Visual feedback for successful highlighting
          const toast = document.createElement("div");
          toast.style.position = "fixed";
          toast.style.bottom = "20px";
          toast.style.left = "50%";
          toast.style.transform = "translateX(-50%)";
          toast.style.background = "rgba(0,0,0,0.7)";
          toast.style.color = "white";
          toast.style.padding = "8px 16px";
          toast.style.borderRadius = "20px";
          toast.style.zIndex = "9999";
          toast.textContent = currentNote ? "Highlight and note saved" : "Highlight saved";
          document.body.appendChild(toast);
          
          // Remove toast after 2 seconds
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 2000);
        }
      });
      
      // Cancel highlight button
      const cancelHighlightBtn = document.getElementById("cancel-highlight");
      cancelHighlightBtn.addEventListener("click", () => {
        if (window.selectedParagraph) {
          window.selectedParagraph.style.border = "none"; // Remove selection border
        }
        document.getElementById("highlight-menu").style.display = "none";
      });
      
      // Apply saved highlights
      if (bookHighlights["Demo Book"]) {
        bookHighlights["Demo Book"].forEach((highlight, index) => {
          // For demo, apply highlight to a random paragraph
          const randomIndex = index % paragraphs.length;
          paragraphs[randomIndex].className = "highlight-" + highlight.color;
          
          // Also add a data attribute to link the paragraph to the highlight
          paragraphs[randomIndex].setAttribute("data-highlight-id", highlight.cfiRange);
          
          // Add note indicator and note display if there's a note
          if (highlight.note) {
            paragraphs[randomIndex].classList.add("has-note");
            
            // Add note content directly inside paragraph
            const noteDisplay = document.createElement("div");
            noteDisplay.className = "note-display";
            noteDisplay.textContent = highlight.note;
            paragraphs[randomIndex].appendChild(noteDisplay);
          }
          
          // Add control buttons for edit/delete
          const controls = document.createElement("div");
          controls.className = "highlight-controls";
          controls.innerHTML = `
            <button class="highlight-edit" title="Edit Note">‚úèÔ∏è</button>
            <button class="highlight-delete" title="Delete Highlight">üóëÔ∏è</button>
          `;
          paragraphs[randomIndex].appendChild(controls);
          
          // Setup event listeners for buttons
          const editBtn = controls.querySelector(".highlight-edit");
          const deleteBtn = controls.querySelector(".highlight-delete");
          
          // Edit note (or add one if none exists)
          editBtn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent other handlers
            
            // Set active element for saving
            activeHighlightElement = paragraphs[randomIndex];
            const highlightId = paragraphs[randomIndex].getAttribute("data-highlight-id");
            
            // Find the highlight in saved highlights
            const bookTitle = "Demo Book";
            const highlightIndex = bookHighlights[bookTitle].findIndex(h => h.cfiRange === highlightId);
            
            if (highlightIndex !== -1) {
              // Show popup with current note
              const notePopup = document.getElementById("note-popup");
              const noteTextarea = document.getElementById("edit-note-text");
              
              // Set current note text
              noteTextarea.value = bookHighlights[bookTitle][highlightIndex].note || "";
              
              // Show popup
              notePopup.style.display = "block";
            }
          });
          
          // Delete highlight
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent other handlers
            
            if (confirm("Are you sure you want to delete this highlight?")) {
              const highlightId = paragraphs[randomIndex].getAttribute("data-highlight-id");
              deleteHighlight(highlightId, paragraphs[randomIndex]);
            }
          });
        });
      }
      
      // Initialize the reading mode
      if (iframe && iframe.contentDocument && iframe.contentDocument.body) {
        // Set default to hidden overflow (paginated mode)
        iframe.style.overflowY = "hidden";
        iframe.contentDocument.body.style.overflow = "hidden";
      }
    }

    // Toggle Library and Reader Views
    function toggleLibrary(forceLibrary) {
      const libraryContainer = document.getElementById("library-container");
      const readerContainer = document.getElementById("reader-container");
      
      if (forceLibrary) {
        libraryContainer.style.display = "block";
        readerContainer.style.display = "none";
      } else {
        libraryContainer.style.display = "none";
        readerContainer.style.display = "block";
      }
      closeMenus();
    }

    // Menu and Interaction Utilities
    function toggleMenu(type) {
      const expandedMenu = document.getElementById("expanded-menu");
      const menuBackdrop = document.getElementById("menu-backdrop");

      if (type === 'menu') {
        expandedMenu.classList.toggle("open");
        menuBackdrop.style.display = expandedMenu.classList.contains("open") ? "block" : "none";
        
        // Update highlights list if opening menu
        if (expandedMenu.classList.contains("open")) {
          updateHighlightsList();
        }
      }
    }

    function closeMenus() {
      const expandedMenu = document.getElementById("expanded-menu");
      const menuBackdrop = document.getElementById("menu-backdrop");
      const highlightMenu = document.getElementById("highlight-menu");
      
      expandedMenu.classList.remove("open");
      menuBackdrop.style.display = "none";
      highlightMenu.style.display = "none";
    }

    // Menu Toggle Event
    document.getElementById("menu-toggle").addEventListener("click", () => toggleMenu('menu'));
    document.getElementById("menu-backdrop").addEventListener("click", closeMenus);
    
    // Save highlight to storage
    function saveHighlight(cfiRange, color, note = "") {
      const bookTitle = "Demo Book";
      
      // Initialize if needed
      if (!bookHighlights[bookTitle]) {
        bookHighlights[bookTitle] = [];
      }
      
      // Add highlight to the array
      bookHighlights[bookTitle].push({
        cfiRange: cfiRange,
        text: selectedText.substring(0, 100) + (selectedText.length > 100 ? "..." : ""),
        color: color,
        type: "highlight",
        note: note,
        timestamp: new Date().toISOString()
      });
      
      // Save to local storage
      try {
        localStorage.setItem("bookHighlights", JSON.stringify(bookHighlights));
      } catch (e) {
        console.error("Error saving to localStorage:", e);
      }
      
      // Update highlights list in menu
      updateHighlightsList();
    }
    
    // Delete highlight
    function deleteHighlight(highlightId, element) {
      const bookTitle = "Demo Book";
      
      // Find the highlight in the array
      const index = bookHighlights[bookTitle].findIndex(h => h.cfiRange === highlightId);
      
      if (index !== -1) {
        // Remove from array
        bookHighlights[bookTitle].splice(index, 1);
        
        // Save updated highlights
        try {
          localStorage.setItem("bookHighlights", JSON.stringify(bookHighlights));
        } catch (e) {
          console.error("Error saving to localStorage:", e);
        }
        
        // Remove highlight from DOM
        element.className = ""; // Remove highlight class
        element.classList.remove("has-note");
        
        // Remove note display if exists
        const noteDisplay = element.querySelector(".note-display");
        if (noteDisplay) {
          element.removeChild(noteDisplay);
        }
        
        // Remove controls
        const controls = element.querySelector(".highlight-controls");
        if (controls) {
          element.removeChild(controls);
        }
        
        // Update highlights list
        updateHighlightsList();
        
        // Show toast message
        showToast("Highlight deleted");
      }
    }
    
    // Update note
    function updateNote(element, note) {
      const bookTitle = "Demo Book";
      const highlightId = element.getAttribute("data-highlight-id");
      
      // Find the highlight in the array
      const index = bookHighlights[bookTitle].findIndex(h => h.cfiRange === highlightId);
      
      if (index !== -1) {
        // Update note
        bookHighlights[bookTitle][index].note = note;
        
        // Save updated highlights
        try {
          localStorage.setItem("bookHighlights", JSON.stringify(bookHighlights));
        } catch (e) {
          console.error("Error saving to localStorage:", e);
        }
        
        // Update display
        if (note) {
          // Add 'has-note' class if not already present
          element.classList.add("has-note");
          
          // Update or create note display
          let noteDisplay = element.querySelector(".note-display");
          if (!noteDisplay) {
            noteDisplay = document.createElement("div");
            noteDisplay.className = "note-display";
            element.appendChild(noteDisplay);
          }
          noteDisplay.textContent = note;
        } else {
          // Remove 'has-note' class and note display if note is empty
          element.classList.remove("has-note");
          const noteDisplay = element.querySelector(".note-display");
          if (noteDisplay) {
            element.removeChild(noteDisplay);
          }
        }
        
        // Update highlights list
        updateHighlightsList();
        
        // Show toast message
        showToast("Note updated");
      }
    }
    
    // Helper function to show toast messages
    function showToast(message) {
      const toast = document.createElement("div");
      toast.style.position = "fixed";
      toast.style.bottom = "20px";
      toast.style.left = "50%";
      toast.style.transform = "translateX(-50%)";
      toast.style.background = "rgba(0,0,0,0.7)";
      toast.style.color = "white";
      toast.style.padding = "8px 16px";
      toast.style.borderRadius = "20px";
      toast.style.zIndex = "9999";
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Remove toast after 2 seconds
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 2000);
    }
    
    // Load highlights from storage
    function loadHighlights(bookTitle) {
      try {
        const savedHighlights = localStorage.getItem("bookHighlights");
        if (savedHighlights) {
          bookHighlights = JSON.parse(savedHighlights);
        } else {
          bookHighlights = {};
        }
        
        // Ensure the current book's highlights are initialized
        if (!bookHighlights[bookTitle]) {
          bookHighlights[bookTitle] = [];
        }
        
        // Update highlights list
        updateHighlightsList();
        
      } catch (e) {
        console.error("Error loading highlights:", e);
        bookHighlights = {};
      }
    }
    
    // Update highlights list in the menu
    function updateHighlightsList() {
      const highlightsList = document.getElementById("highlights-list");
      const bookTitle = "Demo Book";
      
      // Clear current list
      highlightsList.innerHTML = "";
      
      // Add each highlight to the list
      if (bookHighlights[bookTitle] && bookHighlights[bookTitle].length > 0) {
        bookHighlights[bookTitle].forEach((highlight, index) => {
          const highlightDiv = document.createElement("div");
          highlightDiv.className = "highlight-item";
          highlightDiv.style.borderLeft = `4px solid ${getColorHex(highlight.color)}`;
          
          // Add text content
          const textSpan = document.createElement("div");
          textSpan.textContent = highlight.text;
          highlightDiv.appendChild(textSpan);
          
          // Add note content if exists
          if (highlight.note) {
            const noteSpan = document.createElement("div");
            noteSpan.className = "highlight-note-indicator";
            noteSpan.textContent = "üìù " + highlight.note;
            highlightDiv.appendChild(noteSpan);
          }
          
          // Jump to highlight when clicked
          highlightDiv.addEventListener("click", () => {
            // For demo - find paragraph with matching data attribute
            const iframe = document.querySelector("#viewer iframe");
            if (iframe && iframe.contentDocument) {
              const paragraphs = iframe.contentDocument.querySelectorAll("p");
              paragraphs.forEach(p => {
                if (p.getAttribute("data-highlight-id") === highlight.cfiRange) {
                  p.scrollIntoView({ behavior: "smooth", block: "center" });
                  
                  // Flash effect to show location
                  const originalColor = p.style.backgroundColor;
                  p.style.backgroundColor = "rgba(255,255,255,0.8)";
                  setTimeout(() => {
                    p.style.backgroundColor = originalColor;
                  }, 1000);
                }
              });
            }
            
            // In a real implementation, we would use rendition.display(highlight.cfiRange)
            closeMenus();
          });
          
          highlightsList.appendChild(highlightDiv);
        });
      } else {
        highlightsList.innerHTML = "<p>No highlights for this book yet.</p>";
      }
    }
    
    // Get color hex value from name
    function getColorHex(colorName) {
      const colors = {
        yellow: "#ffff00",
        green: "#00ff00",
        blue: "#00c8ff",
        pink: "#ff69b4"
      };
      return colors[colorName] || "#ffff00";
    }
    
    // Initialize the demo
    document.addEventListener("DOMContentLoaded", function() {
      // Start with library view
      toggleLibrary(true);
      
      // Setup note popup events
      const notePopup = document.getElementById("note-popup");
      const saveNoteBtn = document.getElementById("save-note");
      const cancelNoteBtn = document.getElementById("cancel-note");
      
      // Save note
      saveNoteBtn.addEventListener("click", () => {
        if (activeHighlightElement) {
          const noteText = document.getElementById("edit-note-text").value;
          updateNote(activeHighlightElement, noteText);
          
          // Hide popup
          notePopup.style.display = "none";
          
          // Reset active element
          activeHighlightElement = null;
        }
      });
      
      // Cancel note edit
      cancelNoteBtn.addEventListener("click", () => {
        notePopup.style.display = "none";
        activeHighlightElement = null;
      });
      
      // Close popup if clicked outside
      window.addEventListener("click", (e) => {
        if (e.target === notePopup) {
          notePopup.style.display = "none";
          activeHighlightElement = null;
        }
      });
    });
  </script>
</body>
</html>

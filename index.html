<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EPUB Highlight Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- EPUB.js + JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- INLINE STYLES -->
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #library, #reader { width:100%; height:100%; display:none; }
    #library { padding:1rem; box-sizing:border-box; overflow-y:auto; }
    #library h1 { margin-top:0; }
    .book { display:inline-block; width:120px; margin:0.5rem; text-align:center;
             cursor:pointer; border:1px solid #ddd; padding:0.5rem; border-radius:4px; }
    .book img { width:100%; height:auto; }
    #reader { position:relative; }
    #viewer { position:absolute; top:0; left:0; right:0; bottom:0; }
    /* Tap zones */
    #tap-left, #tap-right {
      position:absolute; top:0; bottom:0; width:30%; z-index:5;
    }
    #tap-left { left:0; }
    #tap-right { right:0; }
  </style>
</head>
<body>

  <!-- LIBRARY -->
  <div id="library">
    <h1>My Book Library</h1>
    <div id="books">Loading…</div>
  </div>

  <!-- READER -->
  <div id="reader">
    <div id="viewer"></div>
    <div id="tap-left"></div>
    <div id="tap-right"></div>
  </div>

  <!-- INLINE SCRIPT -->
  <script>
    let book, rendition;

    // 1️⃣ Load library.json and render grid
    function loadLibrary() {
      const container = document.getElementById('books');
      fetch('/ebooks/library.json')
        .then(r => r.json())
        .then(list => {
          container.innerHTML = '';
          list.forEach(b => {
            const div = document.createElement('div');
            div.className = 'book';
            div.innerHTML = \`
              <img src="\${b.cover}" alt="Cover"/><br>
              <strong>\${b.title}</strong><br>
              <em>\${b.author}</em>
            \`;
            div.onclick = () => openBook(b.fileUrl);
            container.appendChild(div);
          });
        })
        .catch(() => container.textContent = 'Failed to load library.');
    }

    // 2️⃣ Switch to reader and initialize
    function openBook(url) {
      document.getElementById('library').style.display = 'none';
      document.getElementById('reader').style.display = 'block';

      if (rendition) rendition.destroy();
      book = ePub(url);
      rendition = book.renderTo('viewer', {
        width: '100%', height: '100%', flow: 'paginated'
      });

      // Highlight theme
      rendition.themes.register('hl', { 'fill': 'yellow', 'fill-opacity': '0.4' });

      // On text select → highlight
      rendition.on('selected', (cfiRange, contents) => {
        rendition.annotations.highlight(cfiRange, {}, null, 'hl');
        contents.window.getSelection().removeAllRanges();
      });

      // Tap zones
      document.getElementById('tap-left').onclick = () => rendition.prev();
      document.getElementById('tap-right').onclick = () => rendition.next();

      rendition.display();
    }

    // Kick things off
    window.onload = () => {
      document.getElementById('library').style.display = 'block';
      loadLibrary();
    };
  </script>
</body>
</html>

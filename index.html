<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My ePub Reader and Library</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />

  <!-- JSZip and epub.js for the reader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- ===== SECTION: Global Styles and Themes ===== -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
      overflow: hidden;
    }

    /* ===== Theme Classes for the Body ===== */
    body.light-mode { background: #f5f5f5; }
    body.light-mode #toolbar { background: #eee; }
    body.sepia-mode { background: #f4ecd8; }
    body.sepia-mode #toolbar { background: #e7dbc3; }
    body.matcha-mode { background: #C3D8B6; }
    body.matcha-mode #toolbar { background: #B0CFA3; }
    body.night-mode { background: #111 !important; }
    body.night-mode #toolbar { background: #222 !important; }
    body.night-mode #continue-bar { background: #111 !important; color: #eee !important; }

    /* ===== SECTION: Layout Containers ===== */
    #reader-container {
      display: none;
      position: relative;
      width: 100%;
      height: 100%;
    }
    #library-container {
      display: none;
      position: relative;
      min-height: 100vh;
      background: #f5f5f5;
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
    }
    h1 { text-align: center; margin: 0 0 1rem; }

    /* ===== SECTION: Library Styling ===== */
    #library-controls { text-align: center; margin-bottom: 1rem; }
    #library {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 1rem;
    }
    .book {
      background: #fff;
      border: 1px solid #ddd;
      padding: 0.75rem;
      width: 140px;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
    }
    .book img { width: 100%; height: auto; border-radius: 4px; }
    .book h3 { font-size: 0.9rem; margin: 0.5rem 0 0.25rem; }
    .book p { font-size: 0.8rem; margin: 0 0 0.5rem; color: #555; }
    .book button {
      margin: 4px 0;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .book button:hover { background-color: #0056b3; }

    /* ===== SECTION: Reader Toolbar ===== */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      z-index: 3000;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      padding: 0 10px;
    }
    #toolbar button {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.8;
    }
    #toolbar button:hover { opacity: 1; }

    /* ===== SECTION: Slide-out Menu & Backdrop Styles ===== */
    #menu-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1999;
    }
    #expanded-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100vh;
      background: #fff;
      z-index: 2000;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      box-shadow: 2px 0 6px rgba(0,0,0,0.2);
      padding: 1rem;
      box-sizing: border-box;
    }
    #expanded-menu.open { transform: translateX(0); }
    #book-card img { width: 100%; height: auto; border-radius: 4px; }

    /* ===== SECTION: Table of Contents Panel ===== */
    #toc-panel {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      background: rgba(255,255,255,0.96);
      z-index: 2500;
      transform: translateY(-100%);
      transition: transform 0.25s ease;
      border-bottom: 1px solid #ccc;
    }
    #toc-panel.open { transform: translateY(0); }
    #toc-panel a {
      display: block;
      padding: 8px 12px;
      color: #000;
      text-decoration: none;
      border-bottom: 1px solid #e6e6e6;
    }
    #toc-panel a:hover { background: #f5f5f5; }

    /* ===== SECTION: Bookmark Dropdown Panel ===== */
    #bookmark-panel {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      height: 70vh;
      overflow-y: auto;
      background: rgba(0,0,0,0.85);
      border-bottom: 1px solid #444;
      z-index: 2500;
      transition: transform 0.3s ease;
      transform: translateY(-100%);
    }
    #bookmark-panel.open { transform: translateY(0); }
    #bookmark-panel div {
      display: block;
      padding: 6px 10px;
      text-decoration: none;
      color: #fff;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    #bookmark-panel div:hover { background: rgba(255,255,255,0.1); }

    /* ===== SECTION: Viewer & Footer ===== */
    #viewer {
      position: absolute;
      top: 40px;           /* below toolbar */
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }
    #continue-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 32px;
      line-height: 32px;
      text-align: center;
      background: #eee;
      display: none;
      z-index: 2600;
    }
    #progress-bar {
      position: fixed;
      bottom: 32px;
      left: 0;
      right: 0;
      height: 4px;
      background: #007bff;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.25s;
      z-index: 2600;
    }
    /* tap / gesture zones */
    #tap-left, #tap-right, #gesture-left, #gesture-right {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
    }
    #tap-left, #gesture-left { left: 0; }
    #tap-right, #gesture-right { right: 0; }
    #gesture-left, #gesture-right { pointer-events: none; }

  </style>
</head>
<body class="light-mode">

  <!-- ===== SECTION: Library Container ===== -->
  <div id="library-container">
    <h1>ðŸ“š My Book Library</h1>
    <div id="library-controls">
      <button onclick="toggleLibrary(false)">Back to Reader</button>
    </div>
    <div id="library">Loading books...</div>
  </div>

  <!-- ===== SECTION: Reader Container & Toolbar ===== -->
  <div id="reader-container">
    <div id="toolbar">
      <button id="menu-toggle" title="Main Menu">â˜°</button>
      <button id="toc-toggle" title="Table of Contents">ðŸ“–</button>
      <button id="bookmark-toggle" title="Toggle Bookmark">â˜†</button>
      <button id="bookmark-dropdown" title="Bookmarks">ðŸ”–</button>
      <button id="settings-toggle" title="Read Settings">Aa</button>
      <button id="theme-toggle" title="Toggle Night Mode">ðŸŒ™</button>
    </div>

    <!-- ===== SECTION: Bookmark Panel Dropdown ===== -->
    <div id="bookmark-panel"></div>

    <!-- ===== SECTION: Slide-out Menu and Backdrop ===== -->
    <div id="menu-backdrop"></div>
    <div id="expanded-menu">
      <button class="close-menu" onclick="toggleMenu('menu')">Ã—</button>
      <div id="book-card">
        <img id="cover" alt="Book Cover" />
        <div id="book-title"></div>
        <div id="book-author"></div>
        <div id="contact-image"></div>
      </div>
      <button class="menu-button" onclick="toggleLibrary(true)">Library</button>
    </div>

    <!-- ===== SECTION: Table of Contents Panel ===== -->
    <div id="toc-panel"></div>

    <!-- ===== SECTION: Settings Modal ===== -->
    <div id="settings-modal">
      <button class="close-settings" onclick="toggleMenu('settings')">Ã—</button>
      <h3>Reading Settings</h3>
      <!-- ===== Subsection: Font Switcher ===== -->
      <label for="font-switcher">Font</label>
      <select id="font-switcher">
        <option value="-apple-system">San Francisco (System)</option>
        <option value="Helvetica Neue">Helvetica Neue</option>
        <option value="Arial">Arial</option>
        <option value="Courier New">Courier New</option>
        <option value="Georgia">Georgia</option>
        <option value="OpenDyslexic">OpenDyslexic</option>
      </select>
      <div class="font-size-buttons">
        <button onclick="changeFontSize(-1)">A-</button>
        <button onclick="changeFontSize(1)">A+</button>
      </div>

      <!-- ===== Subsection: Reading Mode ===== -->
      <label for="reading-mode">Reading Mode</label>
      <select id="reading-mode">
        <option value="paginated">Page</option>
        <option value="scrolled-doc">Scroll</option>
        <option value="swipe">Swipe</option>
      </select>

      <!-- ===== Subsection: Theme Selector ===== -->
      <label for="theme-select">Color Theme</label>
      <select id="theme-select">
        <option value="light">Light</option>
        <option value="sepia">Sepia</option>
        <option value="night">Night</option>
        <option value="matcha">Matcha Green</option>
      </select>
    </div>

    <!-- ===== SECTION: Viewer Area ===== -->
    <div id="viewer">
      <div id="tap-left"></div>
      <div id="tap-right"></div>
      <!-- Gesture zones are enabled only in swipe mode -->
      <div id="gesture-left"></div>
      <div id="gesture-right"></div>
    </div>

    <!-- ===== SECTION: Footer Elements ===== -->
    <div id="progress-bar"></div>
    <div id="continue-bar">Continue</div>
  </div>

  <!-- ===== SECTION: JavaScript Start ===== -->
  <script>
    /* --------------- CONSTANTS & GLOBALS --------------- */
    let currentBookUrl = "";
    let bookmarks = [];
    let xDown = null, yDown = null;
    const SWIPE_THRESHOLD = 20;
    let swipeInProgress = false;
    let book, rendition;
    let currentFontSize = parseInt(localStorage.getItem("reader-font-size")) || 100;
    let currentFlow = localStorage.getItem("reading-mode") || "swipe";

    /* --------------- TAP / SWIPE HELPERS --------------- */
    function tapLeftHandler() { if (currentFlow === "paginated" && rendition) rendition.prev(); }
    function tapRightHandler(){ if (currentFlow === "paginated" && rendition) rendition.next(); }

    /* --------------- CLEAN UP WHEN LEAVING BOOK --------------- */
    function cleanupReader(){
      const viewer=document.getElementById("viewer");
      viewer.removeEventListener("touchstart",handleTouchStart,false);
      viewer.removeEventListener("touchend",handleTouchEnd,false);
      ["gesture-left","gesture-right"].forEach(id=>{
        const el=document.getElementById(id);
        el.removeEventListener("click", id==="gesture-left"?swipePrev:swipeNext);
      });
      ["tap-left","tap-right"].forEach(id=>{
        const el=document.getElementById(id);
        el.removeEventListener("click", id==="tap-left"?tapLeftHandler:tapRightHandler);
      });
    }

    /* --------------- BOOKMARK UTILS --------------- */
    const getBookmarkKey = ()=>"bookmarks_"+currentBookUrl;
    const loadBookmarks =()=>{
      const stored=localStorage.getItem(getBookmarkKey());
      bookmarks=stored?JSON.parse(stored):[];
      updateBookmarkUI();
    };
    const saveBookmarks =()=>{
      localStorage.setItem(getBookmarkKey(),JSON.stringify(bookmarks));
      updateBookmarkUI();
    };
    function updateBookmarkStar(){
      const btn=document.getElementById("bookmark-toggle");
      const cfi=rendition?.currentLocation()?.start?.cfi;
      if(!cfi){btn.textContent="â˜†";return;}
      const exists=bookmarks.some(b=>b.cfi===cfi);
      btn.textContent=exists?"â˜…":"â˜†";
      btn.style.color=exists?"blue":"inherit";
    }

    /* --------------- BOOKMARK PANEL UI --------------- */
    function updateBookmarkUI(){
      const container=document.getElementById("bookmark-panel");
      container.innerHTML="";
      if(bookmarks.length===0){
        const d=document.createElement("div");d.textContent="No bookmarks yet.";container.appendChild(d);
      }else{
        bookmarks.forEach(b=>{
          const d=document.createElement("div");
          d.textContent="Page "+(b.page||"?")+" - "+b.snippet;
          d.addEventListener("click",()=>{rendition.display(b.cfi);toggleBookmarkDropdown();});
          container.appendChild(d);
        });
      }
    }
    function toggleBookmark(){ /* simplified */
      const loc=rendition.currentLocation();
      if(!loc?.start?.cfi)return;
      const cfi=loc.start.cfi, idx=bookmarks.findIndex(b=>b.cfi===cfi);
      if(idx!==-1) bookmarks.splice(idx,1);
      else {
        let snippet="";
        rendition.getContents().some(c=>{
          const txt=c.document.body.textContent.trim();
          if(txt){snippet=txt.slice(0,100)+"â€¦";return true;}
          return false;
        });
        bookmarks.push({cfi,snippet,page:loc.start.index||"?"});
      }
      saveBookmarks();updateBookmarkStar();
    }
    const toggleBookmarkDropdown=()=>document.getElementById("bookmark-panel").classList.toggle("open");

    /* --------------- LIBRARY HANDLING --------------- */
    const urlParams=new URLSearchParams(window.location.search);
    const bookParam=urlParams.get("book");
    const lastSavedBook=localStorage.getItem("last-book");
    let theBookUrl=bookParam?decodeURIComponent(bookParam):(lastSavedBook||null);

    const libraryContainer=document.getElementById("library-container");
    const readerContainer=document.getElementById("reader-container");
    readerContainer.style.display=theBookUrl?"block":"none";
    libraryContainer.style.display=!theBookUrl?"block":"none";
    let libraryVisible=!theBookUrl;

    function toggleLibrary(force){
      libraryVisible=typeof force==="boolean"?force:!libraryVisible;
      libraryContainer.style.display=libraryVisible?"block":"none";
      readerContainer.style.display=libraryVisible?"none":"block";
      closeMenus();
    }
    function loadLibrary(){
      const lib=document.getElementById("library");
      lib.textContent="Loading booksâ€¦";
      fetch("/ebooks/library.json")
        .then(r=>r.json())
        .then(books=>{
          lib.innerHTML="";
          books.forEach(b=>{
            const d=document.createElement("div");d.className="book";
            d.innerHTML=`<img src="${b.cover}" alt="Cover of ${b.title}" />
                         <h3>${b.title}</h3><p>${b.author}</p>
                         <button onclick="readBook('${b.fileUrl}')">Read</button>`;
            lib.appendChild(d);
          });
        }).catch(()=>lib.textContent="Failed to load book list.");
    }
    loadLibrary();

    /* --------------- SWITCH / LOAD BOOK --------------- */
    function readBook(url){
      if(rendition&&currentBookUrl){
        const loc=rendition.currentLocation();
        if(loc?.start?.cfi) localStorage.setItem("last-location-"+currentBookUrl,loc.start.cfi);
      }
      cleanupReader();
      localStorage.setItem("last-book",url);
      const qs=new URLSearchParams(window.location.search);qs.set("book",url);
      window.history.replaceState({}, "",`?${qs.toString()}`);
      initBook(url);toggleLibrary(false);
    }

    /* --------------- SWIPE LISTENERS --------------- */
    function updateSwipeListeners(){
      const viewer=document.getElementById("viewer");
      if(currentFlow==="swipe"){
        ["tap-left","tap-right"].forEach(id=>document.getElementById(id).style.pointerEvents="none");
        viewer.addEventListener("touchstart",handleTouchStart,false);
        viewer.addEventListener("touchend",handleTouchEnd,false);
        ["gesture-left","gesture-right"].forEach((id,i)=>{
          const el=document.getElementById(id);
          el.style.pointerEvents="auto";
          el.addEventListener("click", i===0?swipePrev:swipeNext);
        });
      }else{
        viewer.removeEventListener("touchstart",handleTouchStart,false);
        viewer.removeEventListener("touchend",handleTouchEnd,false);
        ["gesture-left","gesture-right"].forEach(id=>{
          const el=document.getElementById(id);
          el.removeEventListener("click", id==="gesture-left"?swipePrev:swipeNext);
          el.style.pointerEvents="none";
        });
        ["tap-left","tap-right"].forEach(id=>document.getElementById(id).style.pointerEvents="auto");
      }
    }
    function handleTouchStart(e){if(currentFlow!=="swipe")return;xDown=e.touches[0].clientX;yDown=e.touches[0].clientY;}
    function handleTouchEnd(e){
      if(currentFlow!=="swipe"||!xDown||!yDown)return;
      const xUp=e.changedTouches[0].clientX, yUp=e.changedTouches[0].clientY;
      const xDiff=xDown-xUp, yDiff=yDown-yUp;
      if(Math.abs(xDiff)>Math.abs(yDiff)&&Math.abs(xDiff)>SWIPE_THRESHOLD){xDiff>0?swipeNext():swipePrev();}
      xDown=yDown=null;
    }
    function swipeNext(){
      if(swipeInProgress)return;swipeInProgress=true;
      const viewer=document.getElementById("viewer");
      viewer.style.transition="transform .3s";viewer.style.transform="translateX(-100%)";
      setTimeout(()=>{rendition.next();viewer.style.transform="";swipeInProgress=false;},300);
    }
    function swipePrev(){
      if(swipeInProgress)return;swipeInProgress=true;
      const viewer=document.getElementById("viewer");
      viewer.style.transition="transform .3s";viewer.style.transform="translateX(100%)";
      setTimeout(()=>{rendition.prev();viewer.style.transform="";swipeInProgress=false;},300);
    }

    /* --------------- FONT SWITCH / SIZE / THEME --------------- */
    function applyFontSwitch(){
      const stored=localStorage.getItem("reader-font")||"-apple-system";
      document.getElementById("font-switcher").value=stored;
      if(!rendition)return;
      rendition.themes.override("body",{ "font-family":
        stored==="OpenDyslexic"?"'OpenDyslexic', sans-serif !important":stored+", serif !important" });
      if(stored==="OpenDyslexic"){
        const style=`@font-face{font-family:'OpenDyslexic';src:url('/fonts/OpenDyslexic-Regular.otf') format('opentype');}
                     @font-face{font-family:'OpenDyslexic';src:url('/fonts/OpenDyslexic-Bold.otf') format('opentype');font-weight:bold;}
                     body{font-family:'OpenDyslexic',sans-serif!important;}`;
        rendition.getContents().forEach(c=>{
          let s=c.document.getElementById("ODStyle");
          if(!s){s=c.document.createElement("style");s.id="ODStyle";c.document.head.appendChild(s);}
          s.textContent=style;
        });
      }
    }
    document.getElementById("font-switcher").addEventListener("change",e=>{
      localStorage.setItem("reader-font",e.target.value);applyFontSwitch();
    });
    function changeFontSize(d){currentFontSize=Math.max(60,Math.min(200,currentFontSize+d*10));
      localStorage.setItem("reader-font-size",currentFontSize);
      rendition?.themes.fontSize(currentFontSize+"%");
    }
    function changeTheme(th){
      document.body.className="";
      document.body.classList.add(
        th==="night"?"night-mode":
        th==="sepia"?"sepia-mode":
        th==="matcha"?"matcha-mode":"light-mode");
      document.getElementById("theme-toggle").textContent=
        document.body.classList.contains("night-mode")?"â˜€ï¸":"ðŸŒ™";
      localStorage.setItem("reader-theme",th);
      document.getElementById("theme-select").value=th;
      applyThemeStylesFromCurrent();
    }

    /* --------------- MENU / SETTINGS --------------- */
    let openMenuType=null;
    function toggleMenu(t){
      if(openMenuType===t){closeMenus();return;}
      closeMenus();
      if(t==="menu"){
        document.getElementById("expanded-menu").classList.add("open");
        document.getElementById("menu-backdrop").style.display="block";
      }else if(t==="settings"){
        document.getElementById("settings-modal").classList.add("open");
      }
      openMenuType=t;
    }
    function closeMenus(){
      document.getElementById("expanded-menu").classList.remove("open");
      document.getElementById("settings-modal").classList.remove("open");
      document.getElementById("menu-backdrop").style.display="none";
      openMenuType=null;
    }

    /* --------------- THEME TO IFRAME --------------- */
    function applyThemeStylesFromCurrent(){
      if(!rendition)return;
      let bg="#f5f5f5",color="#000";
      if(document.body.classList.contains("night-mode")){bg="#111";color="#eee";}
      else if(document.body.classList.contains("sepia-mode")){bg="#f4ecd8";}
      else if(document.body.classList.contains("matcha-mode")){bg="#C3D8B6";}
      rendition.getContents().forEach(c=>{
        c.document.documentElement.style.background=bg;
        c.document.body.style.background=bg;
        c.document.body.style.color=color;
      });
    }

    /* --------------- INIT BOOK + RENDITION --------------- */
    function initBook(url){
      if(!url)return;
      currentBookUrl=url;bookmarks=[];
      rendition?.destroy();book?.destroy();
      book=ePub(url);registerReaderEvents();
      book.ready.then(()=>{
        initRendition(currentFlow);
        setTimeout(()=>book.locations.generate(1600),100);
        book.loaded.metadata.then(meta=>{
          document.getElementById("book-title").textContent=meta.title||"Untitled";
          document.getElementById("book-author").textContent=meta.creator||"";
        });
        book.loaded.cover.then(c=>book.archive.createUrl(c,{base64:true}))
          .then(u=>document.getElementById("cover").src=u).catch(()=>{});
        book.loaded.navigation.then(nav=>{
          const toc=document.getElementById("toc-panel");toc.innerHTML="";
          nav.toc.forEach(ch=>{
            if(/contents|table of contents/i.test(ch.label))return;
            const a=document.createElement("a");a.textContent=ch.label;a.href="#";
            a.onclick=e=>{e.preventDefault();rendition.display(ch.href);toc.classList.remove("open");};
            toc.appendChild(a);
          });
          const about=nav.toc.find(ch=>/about|author/i.test(ch.label));
          if(about){
            const spineItem=book.spine.items.find(i=>i.href.includes(about.href));
            spineItem?.load(book.archive).then(doc=>{
              const img=doc.querySelector("img[src$='.jpg'],img[src$='.png'],img[src$='.jpeg']");
              if(img){
                book.archive.createUrl(img.getAttribute("src"),{base64:true}).then(u=>{
                  const c=document.getElementById("contact-image");
                  c.innerHTML="";const i=new Image();i.src=u;c.appendChild(i);
                });
              }
            });
          }
        });
        applyFontSwitch();loadBookmarks();updateBookmarkStar();
      });
    }
    function initRendition(flow,cfi){
      rendition=book.renderTo("viewer",{width:"100%",height:"100%",
        flow:flow==="scrolled-doc"?"scrolled":"paginated",snap:flow!=="scrolled-doc",spread:"always"});
      registerHooks();
      rendition.display(cfi||localStorage.getItem("last-location-"+currentBookUrl)||undefined);
      rendition.on("relocated",l=>{
        if(l?.start?.cfi){localStorage.setItem("last-location-"+currentBookUrl,l.start.cfi);updateBookmarkStar();}
      });
      rendition.on("rendered",()=>{applyThemeStylesFromCurrent();applyFontSwitch();updateBookmarkStar();});
      updateSwipeListeners();
      if(flow==="scrolled-doc") document.getElementById("toc-panel").classList.remove("open");
    }

    /* --------------- HOOKS & READER EVENTS --------------- */
    function registerHooks(){
      rendition.hooks.content.register(c=>{
        const doc=c.document;
        if(currentFlow==="scrolled-doc"){
          ["margin","padding"].forEach(p=>{
            doc.body.style[p]="0";doc.documentElement.style[p]="0";
          });
          doc.body.style.paddingBottom="30px";
          ["tap-left","tap-right"].forEach(id=>document.getElementById(id).style.pointerEvents="none");
        }else{
          ["tap-left","tap-right"].forEach(id=>document.getElementById(id).style.pointerEvents="auto");
          doc.body.style.paddingTop="20px";doc.body.style.paddingBottom="30px";
        }
        rendition.themes.fontSize(currentFontSize+"%");
        applyThemeStylesFromCurrent();
      });
    }
    function registerReaderEvents(){
      ["tap-left","tap-right"].forEach((id,i)=>{
        document.getElementById(id).addEventListener("click", i===0?tapLeftHandler:tapRightHandler);
      });
    }

    /* --------------- CONTINUE BAR --------------- */
    document.getElementById("continue-bar").onclick=()=>{
      if(!rendition||currentFlow!=="scrolled-doc"){rendition?.next();return;}
      const loc=rendition.currentLocation();
      if(loc?.start?.index!==undefined){
        const next=book.spine.get(loc.start.index+1);
        next?rendition.display(next.href):null;
      }
    };

    /* --------------- TOP-LEVEL INITIALIZATION --------------- */
    if(theBookUrl) initBook(theBookUrl);
    changeTheme(localStorage.getItem("reader-theme")||"light");
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ePub Reader Template</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />

  <!-- Essential Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    /* Layout Containers */
    #reader-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #library-container {
      position: relative;
      min-height: 100vh;
      background: #f5f5f5;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Library Grid */
    #library {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 1rem;
    }

    .book {
      background: #fff;
      border: 1px solid #ddd;
      padding: 0.75rem;
      width: 140px;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
    }

    .book img { 
      width: 100%; 
      height: auto; 
      border-radius: 4px; 
    }

    .book h3 { 
      font-size: 0.9rem; 
      margin: 0.5rem 0 0.25rem; 
    }

    .book p { 
      font-size: 0.8rem; 
      margin: 0 0 0.5rem; 
      color: #555; 
    }

    .book button {
      margin: 4px 0;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .book button:hover { 
      background-color: #0056b3; 
    }

    /* Viewer and Toolbar */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      z-index: 1002;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      background: #eee;
    }

    #toolbar button {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    #viewer {
      position: absolute;
      top: 40px;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }

    /* Slide-out Menu */
    #menu-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1001;
    }

    #expanded-menu {
      position: fixed;
      top: 0;
      bottom: 0;
      left: -100%;
      width: 80%;
      max-width: 300px;
      background: rgba(128,128,128,0.90);
      color: #fff;
      z-index: 1010;
      display: flex;
      flex-direction: column;
      padding: 20px;
      transition: left 0.3s ease;
    }

    #expanded-menu.open { 
      left: 0; 
    }

    #expanded-menu .close-menu {
      align-self: flex-end;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #fff;
    }

    /* Scrolling and Swiping Support */
    .reading-zone {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      z-index: 998;
    }

    #reading-left { left: 0; }
    #reading-right { right: 0; }
  </style>
</head>
<body>
  <!-- Library Container -->
  <div id="library-container">
    <h1>ðŸ“š ePub Reader</h1>
    <div id="library">Loading books...</div>
  </div>

  <!-- Reader Container -->
  <div id="reader-container">
    <div id="toolbar">
      <button id="menu-toggle">â˜°</button>
      <button id="reading-mode-toggle">ðŸ“–</button>
    </div>

    <!-- Menu Backdrop and Expanded Menu -->
    <div id="menu-backdrop"></div>
    <div id="expanded-menu">
      <button class="close-menu" onclick="toggleMenu('menu')">Ã—</button>
      <div id="book-details">
        <h2 id="book-title">Book Title</h2>
        <p id="book-author">Author Name</p>
      </div>
      <button onclick="toggleLibrary(true)">Back to Library</button>
    </div>

    <!-- Viewer Area with Reading Zones -->
    <div id="viewer">
      <div id="reading-left" class="reading-zone"></div>
      <div id="reading-right" class="reading-zone"></div>
    </div>
  </div>

  <script>
    // Global Variables
    let book, rendition;
    let currentBookUrl = null;
    let currentFlow = 'paginated';
    let xDown = null, yDown = null;
    const SWIPE_THRESHOLD = 20;
    let swipeInProgress = false;

    // Library Loading
    function loadLibrary() {
      const libraryDiv = document.getElementById("library");
      fetch("/ebooks/library.json")
        .then(response => response.json())
        .then(books => {
          libraryDiv.innerHTML = "";
          books.forEach(book => {
            const bookDiv = document.createElement("div");
            bookDiv.className = "book";
            bookDiv.innerHTML = `
              <img src="${book.cover}" alt="Cover of ${book.title}" />
              <h3>${book.title}</h3>
              <p>${book.author}</p>
              <button onclick="readBook('${book.fileUrl}')">Read</button>
            `;
            libraryDiv.appendChild(bookDiv);
          });
        })
        .catch(err => {
          console.error("Failed to load library.json:", err);
          libraryDiv.textContent = "Failed to load book list.";
        });
    }
    loadLibrary();

    // Toggle Library and Reader Views
    function toggleLibrary(forceLibrary) {
      const libraryContainer = document.getElementById("library-container");
      const readerContainer = document.getElementById("reader-container");
      
      if (forceLibrary) {
        libraryContainer.style.display = "block";
        readerContainer.style.display = "none";
      } else {
        libraryContainer.style.display = "none";
        readerContainer.style.display = "block";
      }
      closeMenus();
    }

    // Read Book Function
    function readBook(epubUrl) {
      currentBookUrl = epubUrl;
      toggleLibrary(false);
      
      if (book) {
        book.destroy();
      }
      
      book = ePub(epubUrl);
      book.ready.then(() => {
        initRendition(currentFlow);
        
        // Update book details in menu
        book.loaded.metadata.then(meta => {
          document.getElementById("book-title").textContent = meta.title || "Untitled";
          document.getElementById("book-author").textContent = meta.creator || "";
        });
      });
    }

    // Initialize Rendition with Flow Mode
    function initRendition(flowMode) {
      rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        flow: flowMode === "scrolled" ? "scrolled" : "paginated",
        snap: flowMode !== "scrolled"
      });

      // Default display
      rendition.display();

      // Reading Mode Toggle
      setupReadingModeEvents();
    }

    // Reading Mode and Interaction Setup
    function setupReadingModeEvents() {
      const readingModeToggle = document.getElementById("reading-mode-toggle");
      const readingLeft = document.getElementById("reading-left");
      const readingRight = document.getElementById("reading-right");

      // Toggle between paginated and scrolled modes
      readingModeToggle.addEventListener("click", () => {
        currentFlow = currentFlow === 'paginated' ? 'scrolled' : 'paginated';
        if (book) {
          rendition.destroy();
          initRendition(currentFlow);
        }
      });

      // Paginated mode navigation
      if (currentFlow === 'paginated') {
        readingLeft.addEventListener("click", () => {
          if (rendition) rendition.prev();
        });
        readingRight.addEventListener("click", () => {
          if (rendition) rendition.next();
        });
      }

      // Swipe handling
      document.getElementById("viewer").addEventListener("touchstart", handleTouchStart, false);
      document.getElementById("viewer").addEventListener("touchend", handleTouchEnd, false);
    }

    // Touch and Swipe Handlers
    function handleTouchStart(evt) {
      const firstTouch = evt.touches[0];
      xDown = firstTouch.clientX;
      yDown = firstTouch.clientY;
    }

    function handleTouchEnd(evt) {
      if (!xDown || !yDown) return;

      let xUp = evt.changedTouches[0].clientX;
      let yUp = evt.changedTouches[0].clientY;
      let xDiff = xDown - xUp;
      let yDiff = yDown - yUp;

      if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > SWIPE_THRESHOLD) {
        if (rendition) {
          xDiff > 0 ? rendition.next() : rendition.prev();
        }
      }

      xDown = null;
      yDown = null;
    }

    // Menu and Interaction Utilities
    function toggleMenu(type) {
      const expandedMenu = document.getElementById("expanded-menu");
      const menuBackdrop = document.getElementById("menu-backdrop");

      if (type === 'menu') {
        expandedMenu.classList.toggle("open");
        menuBackdrop.style.display = expandedMenu.classList.contains("open") ? "block" : "none";
      }
    }

    function closeMenus() {
      const expandedMenu = document.getElementById("expanded-menu");
      const menuBackdrop = document.getElementById("menu-backdrop");
      
      expandedMenu.classList.remove("open");
      menuBackdrop.style.display = "none";
    }

    // Menu Toggle Event
    document.getElementById("menu-toggle").addEventListener("click", () => toggleMenu('menu'));
    document.getElementById("menu-backdrop").addEventListener("click", closeMenus);
  </script>
</body>
</html>

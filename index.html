<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EPUB Highlight Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- EPUB.js + JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #library, #reader { width:100%; height:100%; position:absolute; top:0; left:0; }
    #library { display:flex; flex-wrap:wrap; padding:1rem; box-sizing:border-box; background:#f5f5f5; overflow-y:auto; }
    .book { width:120px; margin:0.5rem; text-align:center; cursor:pointer;
            border:1px solid #ccc; border-radius:4px; background:#fff; padding:0.5rem; }
    .book img { width:100%; height:auto; border-radius:2px; }
    .book-title { font-size:0.9rem; margin:0.25rem 0; }
    .book-author { font-size:0.8rem; color:#666; margin-bottom:0.5rem; }

    #reader { display:none; background:#fff; }
    #viewer { position:absolute; top:0; left:0; right:0; bottom:0; }
    #tap-left, #tap-right {
      position:absolute; top:0; bottom:0; width:35%; z-index:10;
      background:transparent;
    }
    #tap-left { left:0; }
    #tap-right { right:0; }
  </style>
</head>
<body>

  <!-- LIBRARY VIEW -->
  <div id="library"></div>

  <!-- READER VIEW -->
  <div id="reader">
    <div id="viewer"></div>
    <div id="tap-left"></div>
    <div id="tap-right"></div>
  </div>

  <script>
  (function(){
    const libEl = document.getElementById('library');
    const readerEl = document.getElementById('reader');
    const viewerEl = document.getElementById('viewer');
    let book, rendition;

    // 1️⃣ Load library.json
    fetch('/ebooks/library.json')
      .then(res => {
        if (!res.ok) throw new Error('HTTP '+res.status);
        return res.json();
      })
      .then(list => {
        libEl.innerHTML = '';
        list.forEach(b => {
          const div = document.createElement('div');
          div.className = 'book';
          div.innerHTML = `
            <img src="${b.cover}" alt="Cover of ${b.title}"/>
            <div class="book-title">${b.title}</div>
            <div class="book-author">${b.author}</div>
          `;
          div.addEventListener('click', () => openBook(b.fileUrl));
          libEl.appendChild(div);
        });
      })
      .catch(err => {
        console.error(err);
        libEl.textContent = 'Failed to load library.';
      });

    function openBook(url) {
      // switch views
      libEl.style.display = 'none';
      readerEl.style.display = 'block';

      // destroy previous
      try { rendition && rendition.destroy(); } catch(e){/*ignore*/}
      
      book = ePub(url);
      rendition = book.renderTo(viewerEl, {
        width: '100%', height: '100%', flow: 'paginated'
      });

      // register highlight style
      rendition.themes.register('highlight', {
        'fill': 'yellow',
        'fill-opacity': '0.4'
      });

      // on text select → highlight
      rendition.on('selected', (cfiRange, contents) => {
        rendition.annotations.highlight(cfiRange, {}, null, 'highlight');
        contents.window.getSelection().removeAllRanges();
      });

      // tap zones
      document.getElementById('tap-left').onclick  = () => rendition.prev();
      document.getElementById('tap-right').onclick = () => rendition.next();

      // display first page
      rendition.display().catch(err => console.error('Display error:', err));
    }

    // start on library
    libEl.style.display = 'flex';
  })();
  </script>
</body>
</html>

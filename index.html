<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lightweight E-Reader</title>
  <style>
    :root {
      --primary: #3498db;
      --bg-color: #f8f9fa;
      --text-color: #333;
      --card-bg: #fff;
      --highlight-yellow: rgba(255, 255, 0, 0.3);
      --highlight-green: rgba(0, 255, 0, 0.2);
      --highlight-blue: rgba(0, 191, 255, 0.2);
      --highlight-pink: rgba(255, 105, 180, 0.2);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --card-bg: #2d2d2d;
        --primary: #64b5f6;
        --highlight-yellow: rgba(255, 255, 0, 0.25);
        --highlight-green: rgba(0, 255, 0, 0.15);
        --highlight-blue: rgba(0, 191, 255, 0.15);
        --highlight-pink: rgba(255, 105, 180, 0.15);
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .app {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(125,125,125,0.2);
      margin-bottom: 16px;
    }

    h1 {
      font-size: 24px;
      font-weight: 500;
      margin: 0;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.icon-btn {
      background: none;
      color: var(--primary);
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button.active {
      background: #f1c40f;
      color: #333;
    }

    .library {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .book-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .book-card:hover {
      transform: translateY(-4px);
    }

    .book-cover {
      height: 200px;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .book-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .book-info {
      padding: 12px;
    }

    .book-title {
      font-weight: 600;
      margin: 0 0 4px;
      font-size: 16px;
    }

    .book-author {
      color: #777;
      font-size: 14px;
      margin: 0;
    }

    .reader {
      display: none;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .content {
      font-size: 18px;
      line-height: 1.7;
    }

    .content p {
      margin-bottom: 1em;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(125,125,125,0.2);
    }

    /* Highlight styles */
    p.selected {
      border: 2px dashed #666;
      padding: 8px;
      border-radius: 4px;
    }

    .highlight-yellow {
      background-color: var(--highlight-yellow);
      padding: 2px 0;
      border-radius: 2px;
    }

    .highlight-green {
      background-color: var(--highlight-green);
      padding: 2px 0;
      border-radius: 2px;
    }

    .highlight-blue {
      background-color: var(--highlight-blue);
      padding: 2px 0;
      border-radius: 2px;
    }

    .highlight-pink {
      background-color: var(--highlight-pink);
      padding: 2px 0;
      border-radius: 2px;
    }

    /* Highlight menu */
    .highlight-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      width: 280px;
      max-width: 90vw;
    }

    .color-options {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 12px 0;
    }

    .color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border: 2px solid #333;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
    }

    /* Spinner */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsiveness */
    @media (max-width: 600px) {
      .library {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      
      .book-cover {
        height: 160px;
      }
      
      .content {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>E-Reader</h1>
    </header>

    <div id="library" class="library">
      <div id="library-loading" class="spinner"></div>
    </div>

    <div id="reader" class="reader">
      <div class="toolbar">
        <button id="back-btn">‚Üê Back</button>
        <button id="highlight-btn">Highlight</button>
      </div>
      
      <h2 id="book-title">Book Title</h2>
      <p id="book-author">Author Name</p>
      
      <div id="content" class="content">
        <div id="content-loading" class="spinner"></div>
      </div>
      
      <div class="controls">
        <button id="prev-btn">Previous Page</button>
        <span id="page-info">Page 1 of 1</span>
        <button id="next-btn">Next Page</button>
      </div>
    </div>

    <div id="highlight-menu" class="highlight-menu">
      <h3>Add Highlight</h3>
      <div class="color-options">
        <div class="color-option selected" style="background-color:#ffff00;" data-color="yellow"></div>
        <div class="color-option" style="background-color:#00ff00;" data-color="green"></div>
        <div class="color-option" style="background-color:#00bfff;" data-color="blue"></div>
        <div class="color-option" style="background-color:#ff69b4;" data-color="pink"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="save-highlight">Save</button>
        <button id="cancel-highlight">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const library = document.getElementById('library');
    const reader = document.getElementById('reader');
    const content = document.getElementById('content');
    const backBtn = document.getElementById('back-btn');
    const highlightBtn = document.getElementById('highlight-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');
    const bookTitle = document.getElementById('book-title');
    const bookAuthor = document.getElementById('book-author');
    const highlightMenu = document.getElementById('highlight-menu');
    const saveHighlightBtn = document.getElementById('save-highlight');
    const cancelHighlightBtn = document.getElementById('cancel-highlight');
    const colorOptions = document.querySelectorAll('.color-option');
    const libraryLoading = document.getElementById('library-loading');
    const contentLoading = document.getElementById('content-loading');
    
    // Global Variables
    let books = [];
    let currentBook = null;
    let currentContent = [];
    let currentPage = 0;
    let paragraphsPerPage = 5;
    let highlightMode = false;
    let selectedParagraph = null;
    let selectedColor = 'yellow';
    let highlights = {};
    
    // Initialize the app
    window.addEventListener('DOMContentLoaded', () => {
      loadLibrary();
    });
    
    // Load library data
    function loadLibrary() {
      fetch('/ebooks/library.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          books = data;
          displayLibrary();
        })
        .catch(error => {
          console.error('Error loading library:', error);
          libraryLoading.style.display = 'none';
          
          // Use sample data if fetch fails
          books = [{
            id: 'sample1',
            title: 'Sample Book',
            author: 'Demo Author',
            description: 'This is a sample book to test the e-reader.'
          }];
          displayLibrary();
        });
    }
    
    // Display the library
    function displayLibrary() {
      libraryLoading.style.display = 'none';
      
      // Clear previous books
      const existingBooks = document.querySelectorAll('.book-card');
      existingBooks.forEach(book => book.remove());
      
      // Display books
      books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'book-card';
        
        const coverDiv = document.createElement('div');
        coverDiv.className = 'book-cover';
        
        if (book.coverUrl) {
          const img = document.createElement('img');
          img.src = book.coverUrl;
          img.alt = book.title;
          coverDiv.appendChild(img);
        } else {
          coverDiv.textContent = 'üìö';
        }
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'book-info';
        
        const titleElem = document.createElement('h3');
        titleElem.className = 'book-title';
        titleElem.textContent = book.title;
        
        const authorElem = document.createElement('p');
        authorElem.className = 'book-author';
        authorElem.textContent = book.author;
        
        infoDiv.appendChild(titleElem);
        infoDiv.appendChild(authorElem);
        
        bookCard.appendChild(coverDiv);
        bookCard.appendChild(infoDiv);
        
        bookCard.addEventListener('click', () => openBook(book));
        
        library.appendChild(bookCard);
      });
    }
    
    // Open a book
    function openBook(book) {
      currentBook = book;
      currentPage = 0;
      
      // Update UI
      bookTitle.textContent = book.title;
      bookAuthor.textContent = book.author;
      content.innerHTML = '';
      contentLoading.style.display = 'block';
      
      // Load book content
      fetch(book.contentUrl || `/ebooks/${book.id}.json`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Handle different json structures
          if (Array.isArray(data)) {
            currentContent = data;
          } else if (data.content && Array.isArray(data.content)) {
            currentContent = data.content;
          } else {
            throw new Error('Invalid content format');
          }
          
          // Load highlights
          loadHighlights(book.id);
          
          // Display first page
          displayPage();
          
          // Show reader view
          library.style.display = 'none';
          reader.style.display = 'block';
        })
        .catch(error => {
          console.error('Error loading book:', error);
          contentLoading.style.display = 'none';
          
          // Use sample content
          currentContent = [
            "This is sample paragraph 1.",
            "This is sample paragraph 2.",
            "This is sample paragraph 3.",
            "This is sample paragraph 4.",
            "This is sample paragraph 5.",
            "This is sample paragraph 6.",
            "This is sample paragraph 7.",
            "This is sample paragraph 8."
          ];
          
          loadHighlights(book.id);
          displayPage();
          
          library.style.display = 'none';
          reader.style.display = 'block';
          
          showToast('Using sample content');
        });
    }
    
    // Display current page
    function displayPage() {
      contentLoading.style.display = 'none';
      content.innerHTML = '';
      
      const start = currentPage * paragraphsPerPage;
      const end = Math.min(start + paragraphsPerPage, currentContent.length);
      
      // Update page info
      const totalPages = Math.ceil(currentContent.length / paragraphsPerPage);
      pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
      
      // Enable/disable pagination buttons
      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = currentPage >= totalPages - 1;
      
      // Add paragraphs
      for (let i = start; i < end; i++) {
        const p = document.createElement('p');
        p.textContent = currentContent[i];
        p.setAttribute('data-index', i);
        
        // Apply highlight if exists
        if (highlights[currentBook.id] && highlights[currentBook.id].find(h => h.index === i)) {
          const highlight = highlights[currentBook.id].find(h => h.index === i);
          p.className = `highlight-${highlight.color}`;
        }
        
        // Add click handler for highlight mode
        p.addEventListener('click', () => {
          if (!highlightMode) return;
          
          // Clear previous selection
          if (selectedParagraph) {
            selectedParagraph.classList.remove('selected');
          }
          
          selectedParagraph = p;
          p.classList.add('selected');
          
          // Show highlight menu
          highlightMenu.style.display = 'block';
        });
        
        content.appendChild(p);
      }
    }
    
    // Load highlights from localStorage
    function loadHighlights(bookId) {
      const saved = localStorage.getItem('reader-highlights');
      if (saved) {
        try {
          highlights = JSON.parse(saved);
          
          if (!highlights[bookId]) {
            highlights[bookId] = [];
          }
        } catch (e) {
          console.error('Error loading highlights:', e);
          highlights = { [bookId]: [] };
        }
      } else {
        highlights = { [bookId]: [] };
      }
    }
    
    // Save highlights to localStorage
    function saveHighlights() {
      localStorage.setItem('reader-highlights', JSON.stringify(highlights));
    }
    
    // Show toast notification
    function showToast(message, duration = 2000) {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      // Create new toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Remove after duration
      setTimeout(() => toast.remove(), duration);
    }
    
    // Toggle highlight mode
    highlightBtn.addEventListener('click', () => {
      highlightMode = !highlightMode;
      highlightBtn.classList.toggle('active');
      
      if (highlightMode) {
        showToast('Highlight mode active. Tap on a paragraph.');
      } else {
        showToast('Highlight mode off');
        
        // Clear selection
        if (selectedParagraph) {
          selectedParagraph.classList.remove('selected');
          selectedParagraph = null;
        }
      }
    });
    
    // Color selection
    colorOptions.forEach(option => {
      option.addEventListener('click', () => {
        selectedColor = option.getAttribute('data-color');
        
        // Update UI
        colorOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
      });
    });
    
    // Save highlight
    saveHighlightBtn.addEventListener('click', () => {
      if (!selectedParagraph || !currentBook) return;
      
      const index = parseInt(selectedParagraph.getAttribute('data-index'));
      
      // Apply highlight
      selectedParagraph.className = `highlight-${selectedColor}`;
      selectedParagraph.classList.remove('selected');
      
      // Save highlight
      const highlight = {
        id: Date.now(),
        index: index,
        color: selectedColor,
        timestamp: new Date().toISOString()
      };
      
      highlights[currentBook.id].push(highlight);
      saveHighlights();
      
      // Close menu
      highlightMenu.style.display = 'none';
      selectedParagraph = null;
      
      showToast('Highlight saved');
    });
    
    // Cancel highlight
    cancelHighlightBtn.addEventListener('click', () => {
      if (selectedParagraph) {
        selectedParagraph.classList.remove('selected');
        selectedParagraph = null;
      }
      
      highlightMenu.style.display = 'none';
    });
    
    // Navigation
    backBtn.addEventListener('click', () => {
      reader.style.display = 'none';
      library.style.display = 'grid';
    });
    
    prevBtn.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        displayPage();
        window.scrollTo(0, 0);
      }
    });
    
    nextBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(currentContent.length / paragraphsPerPage);
      if (currentPage < totalPages - 1) {
        currentPage++;
        displayPage();
        window.scrollTo(0, 0);
      }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', event => {
      if (reader.style.display === 'none') return;
      
      if (event.key === 'ArrowLeft' && !prevBtn.disabled) {
        prevBtn.click();
      } else if (event.key === 'ArrowRight' && !nextBtn.disabled) {
        nextBtn.click();
      }
    });
  </script>
</body>
</html>
